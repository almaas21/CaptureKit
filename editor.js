import{d as ht,r as Y,s as rt,c as K,w as Fe,x as Ze,a as Pe,b as L,o as E,e as t,t as ae,y as le,l as ut,u as F,i as de,F as Ce,h as Ee,z as He,A as Oe,n as Me,B as Et,C as wt,m as et,g as Ge,j as Dt,D as At,E as Pt,p as Lt,q as Ot}from"./chunks/main-Bu1yZWFu.js";import{saveProject as nt,getProjectById as jt,getAllProjects as kt,migrateFromLegacyStore as Rt,getAllMedia as Wt,saveMedia as ot,deleteMedia as Ht,deleteProject as Ut}from"./chunks/indexeddb-BQXE7YLk.js";function ct(o="Untitled Project"){return{id:crypto.randomUUID(),name:o,stageWidth:1920,stageHeight:1080,tracks:[{id:crypto.randomUUID(),type:"overlay",label:"OV",clips:[],overlayClips:[],muted:!1,volume:1,zIndex:10},{id:crypto.randomUUID(),type:"video",label:"V1",clips:[],overlayClips:[],muted:!1,volume:1,zIndex:0},{id:crypto.randomUUID(),type:"video",label:"V2",clips:[],overlayClips:[],muted:!1,volume:1,zIndex:1},{id:crypto.randomUUID(),type:"audio",label:"A1",clips:[],overlayClips:[],muted:!1,volume:1,zIndex:0},{id:crypto.randomUUID(),type:"audio",label:"A2",clips:[],overlayClips:[],muted:!1,volume:1,zIndex:0}]}}const Le=ht("editor",()=>{const o=Y(ct()),e=Y(0),n=Y(!1),i=Y(50),s=Y(0),v=Y(!0),p=10,l=Y(null),c=Y(null),y=Y(null),r=Y("scale"),u=50,D=rt([]),I=rt([]),J=K(()=>D.value.length>0),Q=K(()=>I.value.length>0);function R(){D.value.push(JSON.stringify(o.value)),D.value.length>u&&D.value.shift(),Ze(D),I.value=[]}function ee(){if(D.value.length===0)return;I.value.push(JSON.stringify(o.value)),Ze(I);const m=D.value.pop();Ze(D),o.value=JSON.parse(m)}function ue(){if(I.value.length===0)return;D.value.push(JSON.stringify(o.value)),Ze(D);const m=I.value.pop();Ze(I),o.value=JSON.parse(m)}const Z=K(()=>{let m=0;for(const x of o.value.tracks){for(const z of x.clips){const M=z.startTime+z.duration;M>m&&(m=M)}for(const z of x.overlayClips){const M=z.startTime+z.duration;M>m&&(m=M)}}return Math.max(m,10)}),U=K(()=>{if(!l.value)return null;for(const m of o.value.tracks){const x=m.clips.find(z=>z.id===l.value);if(x)return x}return null}),G=K(()=>{if(!y.value)return null;for(const m of o.value.tracks){const x=m.overlayClips.find(z=>z.id===y.value);if(x)return x}return null});function ne(m,x,z){if(!v.value)return{start:m,snapped:!1};const M=p/i.value,A=[0,e.value];for(const Ae of o.value.tracks){for(const Ie of Ae.clips)Ie.id!==z&&A.push(Ie.startTime,Ie.startTime+Ie.duration);for(const Ie of Ae.overlayClips)Ie.id!==z&&A.push(Ie.startTime,Ie.startTime+Ie.duration)}let ie=m,se=1/0;const _=m,ke=m+x;for(const Ae of A){const Ie=Math.abs(_-Ae);Ie<se&&Ie<M&&(se=Ie,ie=Ae);const Xe=Math.abs(ke-Ae);Xe<se&&Xe<M&&(se=Xe,ie=Ae-x)}return{start:Math.max(0,ie),snapped:se<1/0}}function me(m){R();const x=o.value.tracks.filter(ke=>ke.type===m).map(ke=>ke.label),z=m==="video"?"V":m==="audio"?"A":"OV";let M=x.length+1;for(;x.includes(`${z}${M}`);)M++;const A=m==="audio"?0:(()=>{const ke=o.value.tracks.filter(Ae=>Ae.type!=="audio");return ke.length>0?Math.max(...ke.map(Ae=>Ae.zIndex??0))+1:m==="overlay"?10:0})(),ie={id:crypto.randomUUID(),type:m,label:`${z}${M}`,clips:[],overlayClips:[],muted:!1,volume:1,zIndex:A},se={video:0,overlay:1,audio:2},_=o.value.tracks.findIndex(ke=>se[ke.type]>se[m]);_===-1?o.value.tracks.push(ie):o.value.tracks.splice(_,0,ie)}function h(m){R(),o.value.tracks=o.value.tracks.filter(x=>x.id!==m)}function w(m){const x=o.value.tracks.find(z=>z.id===m);x&&(x.muted=!x.muted)}function S(m,x){const z=o.value.tracks.find(M=>M.id===m);z&&(z.volume=Math.max(0,Math.min(1,x)))}function $(m,x){R();const z=o.value.tracks.find(M=>M.id===m);z&&(z.type==="video"||z.type==="audio")&&(z.clips.push(x),z.clips.sort((M,A)=>M.startTime-A.startTime))}function d(m){R();for(const x of o.value.tracks){const z=x.clips.findIndex(M=>M.id===m);if(z!==-1){x.clips.splice(z,1),l.value===m&&(l.value=null);return}}}function b(m,x,z){let M=null,A=null;for(const se of o.value.tracks){const _=se.clips.findIndex(ke=>ke.id===m);if(_!==-1){M=se.clips[_],A=se;break}}if(!M||!A)return;const ie=o.value.tracks.find(se=>se.id===x);!ie||ie.type!=="video"&&ie.type!=="audio"||(M.startTime=Math.max(0,z),A.id!==x&&(A.clips=A.clips.filter(se=>se.id!==m),ie.clips.push(M),ie.clips.sort((se,_)=>se.startTime-_.startTime)))}function C(m,x,z){for(const M of o.value.tracks){const A=M.clips.find(ie=>ie.id===m);if(A){A.trimStart=Math.max(0,x),A.trimEnd=Math.max(0,z);return}}}function j(m,x){for(const z of o.value.tracks){const M=z.clips.find(A=>A.id===m);if(M){Object.assign(M,x);return}}}function X(m){R();for(const x of o.value.tracks){const z=x.clips.findIndex(_=>_.id===m);if(z===-1)continue;const M=x.clips[z],A=e.value-M.startTime;if(A<=.1||A>=M.duration-.1)return;const ie={...M,id:crypto.randomUUID(),duration:A,trimEnd:M.trimEnd+(M.duration-A),blurAreas:M.blurAreas.map(_=>({..._,id:crypto.randomUUID()})),crop:M.crop?{...M.crop}:null},se={...M,id:crypto.randomUUID(),startTime:M.startTime+A,trimStart:M.trimStart+A,duration:M.duration-A,blurAreas:M.blurAreas.map(_=>({..._,id:crypto.randomUUID()})),crop:M.crop?{...M.crop}:null};x.clips.splice(z,1,ie,se);return}}function be(m,x){R();for(const z of o.value.tracks){const M=z.clips.find(A=>A.id===m);if(M){M.blurAreas.push(x);return}}}function xe(m,x){R();for(const z of o.value.tracks){const M=z.clips.find(A=>A.id===m);if(M){M.blurAreas=M.blurAreas.filter(A=>A.id!==x);return}}}function ye(m,x,z){for(const M of o.value.tracks){const A=M.clips.find(ie=>ie.id===m);if(A){const ie=A.blurAreas.find(se=>se.id===x);ie&&Object.assign(ie,z);return}}}function ve(m,x){for(const z of o.value.tracks){const M=z.clips.find(A=>A.id===m);if(M){M.crop=x;return}}}function ge(m){R();for(const x of o.value.tracks){const z=x.clips.find(A=>A.id===m);if(!z?.crop)continue;const M={...z.crop};for(const A of x.clips)A.id!==m&&(A.crop={...M});return}}function P(m){R();for(const x of o.value.tracks){const z=x.clips.find(_=>_.id===m);if(!z)continue;const{stageX:M=0,stageY:A=0,stageW:ie=100,stageH:se=100}=z;for(const _ of x.clips)_.id!==m&&(_.stageX=M,_.stageY=A,_.stageW=ie,_.stageH=se);return}}function W(m,x){R();const z=o.value.tracks.find(M=>M.id===m&&M.type==="overlay");z&&(z.overlayClips.push(x),z.overlayClips.sort((M,A)=>M.startTime-A.startTime))}function N(m,x,z){let M=null,A=null;for(const se of o.value.tracks){const _=se.overlayClips.findIndex(ke=>ke.id===m);if(_!==-1){M=se.overlayClips[_],A=se;break}}if(!M||!A)return;const ie=o.value.tracks.find(se=>se.id===x);!ie||ie.type!=="overlay"||(M.startTime=Math.max(0,z),A.id!==x&&(A.overlayClips=A.overlayClips.filter(se=>se.id!==m),ie.overlayClips.push(M),ie.overlayClips.sort((se,_)=>se.startTime-_.startTime)))}function pe(m){R();for(const x of o.value.tracks){const z=x.overlayClips.findIndex(_=>_.id===m);if(z===-1)continue;const M=x.overlayClips[z],A=e.value-M.startTime;if(A<=.1||A>=M.duration-.1)return;const ie={...M,id:crypto.randomUUID(),duration:A,keyframes:(M.keyframes||[]).filter(_=>_.time<=A)},se={...M,id:crypto.randomUUID(),startTime:M.startTime+A,duration:M.duration-A,keyframes:(M.keyframes||[]).filter(_=>_.time>=A).map(_=>({..._,time:_.time-A}))};x.overlayClips.splice(z,1,ie,se);return}}function we(m){R();for(const x of o.value.tracks){const z=x.overlayClips.findIndex(M=>M.id===m);if(z!==-1){x.overlayClips.splice(z,1),y.value===m&&(y.value=null);return}}}function he(m,x){for(const z of o.value.tracks){const M=z.overlayClips.find(A=>A.id===m);if(M){Object.assign(M,x);return}}}function Re(m){e.value=Math.max(0,Math.min(Z.value,m))}function a(m){n.value=m}function k(m,x){if(l.value=m,y.value=null,x)c.value=x;else if(m){for(const z of o.value.tracks)if(z.clips.find(M=>M.id===m)){c.value=z.id;return}c.value=null}else c.value=null}function g(m){y.value=m,l.value=null}function O(){l.value=null,y.value=null,c.value=null}function f(m,x){R(),o.value.stageWidth=Math.floor(Math.max(2,m)/2)*2,o.value.stageHeight=Math.floor(Math.max(2,x)/2)*2}function T(m,x){const z=o.value.tracks.find(M=>M.id===m);z&&Number.isFinite(x)&&(R(),z.zIndex=x)}function q(m){const x=o.value.tracks.find(_=>_.id===m);if(!x||x.type==="audio")return;const M=[...o.value.tracks.filter(_=>_.type!=="audio")].sort((_,ke)=>_.zIndex-ke.zIndex),A=M.findIndex(_=>_.id===m);if(A===-1||A===M.length-1)return;R();const ie=M[A+1],se=x.zIndex;x.zIndex=ie.zIndex,ie.zIndex=se,x.zIndex===ie.zIndex&&x.zIndex++}function te(m){const x=o.value.tracks.find(_=>_.id===m);if(!x||x.type==="audio")return;const M=[...o.value.tracks.filter(_=>_.type!=="audio")].sort((_,ke)=>_.zIndex-ke.zIndex),A=M.findIndex(_=>_.id===m);if(A<=0)return;R();const ie=M[A-1],se=x.zIndex;x.zIndex=ie.zIndex,ie.zIndex=se,ie.zIndex===x.zIndex&&ie.zIndex++}function H(m,x){const z=re(m);if(!z)return;const M=Math.max(0,Math.min(z.duration,e.value-z.startTime));z.keyframes||(z.keyframes=[]);const A=z.keyframes.find(ie=>Math.abs(ie.time-M)<.05);A?Object.assign(A,x):(z.keyframes.push({time:M,...x}),z.keyframes.sort((ie,se)=>ie.time-se.time))}function V(m,x){const z=re(m);if(!z?.keyframes?.length)return;const M=Math.max(0,Math.min(z.duration,e.value-z.startTime)),A=z.keyframes.find(ie=>Math.abs(ie.time-M)<.05);A&&(Object.assign(A,x),A.time=M)}function B(m,x){const z=re(m);z?.keyframes&&x>=0&&x<z.keyframes.length&&z.keyframes.splice(x,1)}function oe(m){const x=re(m);x&&(x.keyframes=[])}function re(m){for(const x of o.value.tracks){const z=x.overlayClips.find(M=>M.id===m);if(z)return z}return null}function fe(m){i.value=Math.max(5,Math.min(500,m))}function ce(m){let x=0;for(const z of m.tracks)z.zIndex==null&&(z.type==="overlay"?z.zIndex=10:z.type==="video"?z.zIndex=x++:z.zIndex=0);o.value=m,e.value=0,n.value=!1,O(),D.value=[],I.value=[]}function ze(m){o.value=ct(m),e.value=0,n.value=!1,O(),D.value=[],I.value=[]}let $e=null;function Te(){$e&&clearTimeout($e),$e=setTimeout(()=>{nt(JSON.parse(JSON.stringify(o.value))).catch(console.error)},2e3)}Fe(()=>JSON.stringify(o.value),()=>Te(),{deep:!1});function Se(m){o.value.name=m}async function je(){await nt(JSON.parse(JSON.stringify(o.value)))}async function Ye(m){o.value={...JSON.parse(JSON.stringify(o.value)),id:crypto.randomUUID(),name:m},await nt(JSON.parse(JSON.stringify(o.value)))}async function _e(m){const x=await jt(m);x&&ce(x)}async function De(){const m=await kt();m.length>0&&ce(m[m.length-1])}return{project:o,currentTime:e,isPlaying:n,zoom:i,scrollX:s,snapEnabled:v,selectedClipId:l,selectedTrackId:c,selectedOverlayId:y,editMode:r,projectDuration:Z,selectedClip:U,selectedOverlay:G,snapTime:ne,addTrack:me,removeTrack:h,toggleTrackMute:w,setTrackVolume:S,addClip:$,removeClip:d,moveClip:b,trimClip:C,updateClip:j,splitClipAtPlayhead:X,addBlurArea:be,removeBlurArea:xe,updateBlurArea:ye,setCrop:ve,applyCropToTrack:ge,applyScaleToTrack:P,addOverlayClip:W,moveOverlayClip:N,splitOverlayAtPlayhead:pe,removeOverlayClip:we,updateOverlayClip:he,seek:Re,setPlaying:a,selectClip:k,selectOverlay:g,clearSelection:O,setStageSize:f,setTrackZIndex:T,moveTrackLayerUp:q,moveTrackLayerDown:te,setKeyframe:H,updateKeyframeIfExists:V,removeKeyframe:B,clearKeyframes:oe,canUndo:J,canRedo:Q,pushSnapshot:R,undo:ee,redo:ue,setZoom:fe,loadProject:ce,newProject:ze,renameProject:Se,saveNow:je,saveAsNewProject:Ye,loadProjectById:_e,loadRecentProject:De}}),Ue=ht("media",()=>{const o=Y([]),e=Y(!1);async function n(){e.value=!0;try{await Rt(),o.value=await Wt(),o.value.sort((l,c)=>new Date(c.createdAt).getTime()-new Date(l.createdAt).getTime());for(const l of o.value)l.type==="video"&&(!l.width||!l.height)&&dt(l.blob).then(c=>{l.width=c.width,l.height=c.height,ot(l).catch(()=>{})}).catch(()=>{})}catch{}finally{e.value=!1}}async function i(l){const c=l.name.split(".").pop()?.toLowerCase()??"",y=["mp4","webm","mkv","avi","mov","ogv","m4v"],r=["mp3","wav","ogg","aac","flac","m4a","wma","opus"],u=l.type.startsWith("video/")||y.includes(c),D=!u&&(l.type.startsWith("audio/")||r.includes(c));if(!u&&!D)return null;const I=l.type||(u?`video/${c}`:`audio/${c}`),J=l.type===I?l:l.slice(0,l.size,I),Q=await Ft(J,u?"video":"audio"),R=u?await dt(J):void 0,ee={id:crypto.randomUUID(),name:l.name,type:u?"video":"audio",blob:J,duration:Q,width:R?.width,height:R?.height,source:"import",createdAt:new Date().toISOString()};if(await ot(ee),o.value.unshift(ee),u&&R){const ue=Le();!ue.project.tracks.some(U=>U.type==="video"&&U.clips.length>0)&&ue.project.stageWidth===1920&&ue.project.stageHeight===1080&&ue.setStageSize(R.width,R.height)}return ee}async function s(){const l=document.createElement("input");return l.type="file",l.multiple=!0,l.accept="video/*,audio/*",new Promise(c=>{l.onchange=async()=>{if(!l.files){c();return}for(const y of Array.from(l.files))await i(y);c()},l.oncancel=()=>c(),l.click()})}async function v(l){try{await Ht(l)}catch{}o.value=o.value.filter(c=>c.id!==l)}async function p(l){await ot(l),o.value.unshift(l)}return{items:o,isLoading:e,load:n,importFile:i,importFiles:s,remove:v,addItem:p}});function Ft(o,e){return new Promise(n=>{const i=URL.createObjectURL(o),s=document.createElement(e);s.preload="metadata";const v=()=>{URL.revokeObjectURL(i),s.remove()};s.onloadedmetadata=()=>{isFinite(s.duration)&&s.duration>0?(v(),n(s.duration)):(s.currentTime=Number.MAX_SAFE_INTEGER,s.onseeked=()=>{const p=s.duration;s.currentTime=0,v(),n(isFinite(p)&&p>0?p:0)})},s.onerror=()=>{v(),n(0)},s.src=i})}function dt(o){return new Promise(e=>{const n=URL.createObjectURL(o),i=document.createElement("video");i.preload="metadata",i.onloadedmetadata=()=>{const s=i.videoWidth,v=i.videoHeight;URL.revokeObjectURL(n),i.remove(),e({width:s||1920,height:v||1080})},i.onerror=()=>{URL.revokeObjectURL(n),i.remove(),e({width:1920,height:1080})},i.src=n})}const Xt=o=>new Promise((e,n)=>{const i=new FileReader;i.onload=()=>{const{result:s}=i;s instanceof ArrayBuffer?e(new Uint8Array(s)):e(new Uint8Array)},i.onerror=s=>{n(Error(`File could not be read! Code=${s?.target?.error?.code||-1}`))},i.readAsArrayBuffer(o)}),Nt=async o=>{let e;if(typeof o=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(o)?e=atob(o.split(",")[1]).split("").map(n=>n.charCodeAt(0)):e=await(await fetch(o)).arrayBuffer();else if(o instanceof URL)e=await(await fetch(o)).arrayBuffer();else if(o instanceof File||o instanceof Blob)e=await Xt(o);else return new Uint8Array;return new Uint8Array(e)};function Bt(o){return o<.5?2*o*o:-1+(4-2*o)*o}function pt(o,e,n,i){const s=Bt(Math.max(0,Math.min(1,e)));switch(o){case"none":return{};case"fade":return{opacity:s*i.opacity};case"slide-left":return{x:i.x-(1-s)*30};case"slide-right":return{x:i.x+(1-s)*30};case"slide-up":return{y:i.y+(1-s)*30};case"slide-down":return{y:i.y-(1-s)*30};case"zoom-in":return{scaleX:s,scaleY:s,opacity:s*i.opacity};case"zoom-out":return{scaleX:2-s,scaleY:2-s,opacity:s*i.opacity};case"typewriter":return n.type==="text"&&n.text?{textLength:s*n.text.length}:{};case"draw-in":return{lineDashProgress:s};default:return{}}}function Yt(o,e,n){const i={x:n.x,y:n.y,scaleX:1,scaleY:1,rotation:n.rotation,opacity:n.opacity},s=o.enterDuration||0,v=o.exitDuration||0;if(s>0&&e<s&&o.enterAnimation!=="none"){const l=e/s,c=pt(o.enterAnimation,l,o,n);return{...i,...c}}const p=o.duration-v;if(v>0&&e>p&&o.exitAnimation!=="none"){const l=1-(e-p)/v,c=pt(o.exitAnimation,l,o,n);return{...i,...c}}return i}const zt=["x","y","width","height","rotation","opacity","p1x","p1y","p2x","p2y"];function _t(o,e,n){return o+(e-o)*n}function Mt(o,e){const n={x:o.x,y:o.y,width:o.width,height:o.height,rotation:o.rotation,opacity:o.opacity,p1x:o.p1x,p1y:o.p1y,p2x:o.p2x,p2y:o.p2y},i=o.keyframes;if(!i||i.length===0)return n;const s=e-o.startTime;if(s<=i[0].time)return vt(n,i[0]);const v=i[i.length-1];if(s>=v.time)return vt(n,v);for(let p=0;p<i.length-1;p++){const l=i[p],c=i[p+1];if(s>=l.time&&s<=c.time){const y=(s-l.time)/(c.time-l.time);return Kt(n,l,c,y)}}return n}function vt(o,e){const n={...o};for(const i of zt){const s=e[i];s!==void 0&&(n[i]=s)}return n}function Kt(o,e,n,i){const s={...o};for(const v of zt){const p=e[v],l=n[v];p!==void 0&&l!==void 0?s[v]=_t(p,l,i):p!==void 0?s[v]=p:l!==void 0&&(s[v]=l)}return s}const qe=new Map;let Tt=null;function ft(o){Tt=o}function Vt(o){let e=qe.get(o);return e||(e=new Image,e.onload=()=>{Tt?.()},e.src=o,qe.set(o,e)),e.complete&&e.naturalWidth>0?e:null}function st(o){return new Promise(e=>{const n=qe.get(o);if(n?.complete&&n.naturalWidth>0){e();return}const i=new Image;i.onload=()=>{qe.set(o,i),e()},i.onerror=()=>e(),i.src=o,qe.set(o,i)})}function Ct(o,e,n,i,s,v=1){const p=n-e.startTime,l=Mt(e,n),c=Yt(e,p,l);if(o.save(),e.shape==="arrow"&&e.p1x!=null&&e.p1y!=null&&e.p2x!=null&&e.p2y!=null){o.globalAlpha=c.opacity,Qt(o,e,l,i,s,v),o.restore();return}const y=c.x/100*i,r=c.y/100*s,u=l.width/100*i*c.scaleX,D=l.height/100*s*c.scaleY;if(o.globalAlpha=c.opacity,o.translate(y+u/2,r+D/2),o.rotate(c.rotation*Math.PI/180),o.translate(-(u/2),-(D/2)),e.type==="text"&&e.text){const I=(e.fontSize||32)*v;o.font=`${e.fontWeight||"normal"} ${I}px ${e.fontFamily||"sans-serif"}`,o.textAlign=e.textAlign||"center",o.textBaseline="middle",e.backgroundColor&&e.backgroundColor!=="none"&&(o.fillStyle=e.backgroundColor,o.fillRect(0,0,u,D));let J=e.text;c.textLength!==void 0&&(J=J.slice(0,Math.floor(c.textLength))),o.fillStyle=e.fontColor||"#ffffff";const Q=4*v,R=e.textAlign==="left"?Q:e.textAlign==="right"?u-Q:u/2;o.fillText(J,R,D/2,u)}else if(e.type==="image"&&e.imageData){const I=Vt(e.imageData);I?o.drawImage(I,0,0,u,D):(o.fillStyle="#333",o.fillRect(0,0,u,D),o.fillStyle="#888",o.font="12px sans-serif",o.textAlign="center",o.fillText("Loadingâ€¦",u/2,D/2))}else e.type==="shape"&&e.shape&&Zt(o,e,u,D,c,v);o.restore()}function Jt(o,e,n,i,s,v=1){for(const p of e)n>=p.startTime&&n<p.startTime+p.duration&&Ct(o,p,n,i,s,v)}function Zt(o,e,n,i,s,v=1){if(o.fillStyle=e.fillColor||"rgba(0,0,0,0)",o.strokeStyle=e.strokeColor||"#ffffff",o.lineWidth=(e.strokeWidth||2)*v,s.lineDashProgress!==void 0){const p=2*(n+i);o.setLineDash([p]),o.lineDashOffset=p*(1-s.lineDashProgress)}switch(e.shape){case"rectangle":e.borderRadius?(o.beginPath(),o.roundRect(0,0,n,i,e.borderRadius),e.fillColor&&e.fillColor!=="none"&&o.fill(),o.stroke()):(e.fillColor&&e.fillColor!=="none"&&o.fillRect(0,0,n,i),o.strokeRect(0,0,n,i));break;case"ellipse":o.beginPath(),o.ellipse(n/2,i/2,n/2,i/2,0,0,Math.PI*2),e.fillColor&&e.fillColor!=="none"&&o.fill(),o.stroke();break;case"triangle":o.beginPath(),o.moveTo(n/2,0),o.lineTo(n,i),o.lineTo(0,i),o.closePath(),e.fillColor&&e.fillColor!=="none"&&o.fill(),o.stroke();break;case"line":o.beginPath(),o.moveTo(0,i/2),o.lineTo(n,i/2),o.stroke();break;case"arrow-right":case"arrow-left":case"arrow-up":case"arrow-down":Gt(o,e.shape,n,i,e.arrowHeadSize||Math.min(n,i)*.3,e.fillColor,e.strokeColor);break;case"star":qt(o,n/2,i/2,5,Math.min(n,i)/2,Math.min(n,i)/4,e.fillColor,e.strokeColor);break;case"callout":{o.beginPath();const p=Math.min(e.borderRadius||8,n/4,i/4);o.roundRect(0,0,n,i*.8,p),o.moveTo(n*.2,i*.8),o.lineTo(n*.15,i),o.lineTo(n*.35,i*.8),e.fillColor&&e.fillColor!=="none"&&o.fill(),o.stroke();break}}}function Gt(o,e,n,i,s,v,p){o.beginPath();const l=s;switch(e){case"arrow-right":o.moveTo(0,i*.35),o.lineTo(n-l,i*.35),o.lineTo(n-l,0),o.lineTo(n,i/2),o.lineTo(n-l,i),o.lineTo(n-l,i*.65),o.lineTo(0,i*.65);break;case"arrow-left":o.moveTo(n,i*.35),o.lineTo(l,i*.35),o.lineTo(l,0),o.lineTo(0,i/2),o.lineTo(l,i),o.lineTo(l,i*.65),o.lineTo(n,i*.65);break;case"arrow-up":o.moveTo(n*.35,i),o.lineTo(n*.35,l),o.lineTo(0,l),o.lineTo(n/2,0),o.lineTo(n,l),o.lineTo(n*.65,l),o.lineTo(n*.65,i);break;case"arrow-down":o.moveTo(n*.35,0),o.lineTo(n*.35,i-l),o.lineTo(0,i-l),o.lineTo(n/2,i),o.lineTo(n,i-l),o.lineTo(n*.65,i-l),o.lineTo(n*.65,0);break}o.closePath(),v&&v!=="none"&&o.fill(),p&&o.stroke()}function qt(o,e,n,i,s,v,p,l){o.beginPath();let c=-Math.PI/2;const y=Math.PI/i;for(let r=0;r<i*2;r++){const u=r%2===0?s:v,D=e+Math.cos(c)*u,I=n+Math.sin(c)*u;r===0?o.moveTo(D,I):o.lineTo(D,I),c+=y}o.closePath(),p&&p!=="none"&&o.fill(),l&&o.stroke()}function Qt(o,e,n,i,s,v){const p=(n.p1x??e.p1x)/100*i,l=(n.p1y??e.p1y)/100*s,c=(n.p2x??e.p2x)/100*i,y=(n.p2y??e.p2y)/100*s,r=e.strokeColor||"#ffffff",u=e.fillColor||r,D=(e.strokeWidth||3)*v,I=(e.arrowHeadSize||18)*v,J=Math.atan2(y-l,c-p);o.strokeStyle=r,o.lineWidth=D,o.lineCap="round",o.beginPath(),o.moveTo(p,l),o.lineTo(c,y),o.stroke(),o.fillStyle=u,o.beginPath(),o.moveTo(c,y),o.lineTo(c-I*Math.cos(J-Math.PI/6),y-I*Math.sin(J-Math.PI/6)),o.lineTo(c-I*Math.cos(J+Math.PI/6),y-I*Math.sin(J+Math.PI/6)),o.closePath(),o.fill()}const We={LOAD:"LOAD",EXEC:"EXEC",WRITE_FILE:"WRITE_FILE",READ_FILE:"READ_FILE",DELETE_FILE:"DELETE_FILE",ERROR:"ERROR",LOG:"LOG",PROGRESS:"PROGRESS"};class en{worker=null;resolves={};rejects={};logCbs=[];progressCbs=[];nextId=0;loaded=!1;on(e,n){e==="log"?this.logCbs.push(n):this.progressCbs.push(n)}async load(){const e=chrome.runtime.getURL("ffmpeg/worker.js"),n=chrome.runtime.getURL("ffmpeg/ffmpeg-core.js"),i=chrome.runtime.getURL("ffmpeg/ffmpeg-core.wasm");this.worker=new Worker(e),this.worker.onmessage=({data:{id:s,type:v,data:p}})=>{switch(v){case We.LOAD:this.loaded=!0,this.resolves[s]?.(p);break;case We.LOG:this.logCbs.forEach(l=>l(p));return;case We.PROGRESS:this.progressCbs.forEach(l=>l(p));return;case We.ERROR:this.rejects[s]?.(new Error(String(p)));break;default:this.resolves[s]?.(p);break}delete this.resolves[s],delete this.rejects[s]},this.worker.onerror=s=>{},await this.send(We.LOAD,{coreURL:n,wasmURL:i})}send(e,n,i=[]){return this.worker?new Promise((s,v)=>{const p=this.nextId++;this.resolves[p]=s,this.rejects[p]=v,this.worker.postMessage({id:p,type:e,data:n},i)}):Promise.reject(new Error("Worker not initialized"))}async exec(e){return this.send(We.EXEC,{args:e,timeout:-1})}async writeFile(e,n){const i=n instanceof Uint8Array?[n.buffer]:[];return this.send(We.WRITE_FILE,{path:e,data:n},i)}async readFile(e){return this.send(We.READ_FILE,{path:e,encoding:"binary"})}async deleteFile(e){return this.send(We.DELETE_FILE,{path:e})}terminate(){this.worker?.terminate(),this.worker=null,this.loaded=!1}}let Ne=null,Be=!1,Ke=[],lt=10,$t=95;async function tn(){return Ne?.loaded||(Ne=new en,Ne.on("log",({message:o})=>{Ke.push(o),Ke.length>200&&Ke.splice(0,50)}),Ne.on("progress",({progress:o})=>{if(!Be)return;const e=Math.min(1,Math.max(0,Number.isFinite(o)?o:0));St.value=lt+e*($t-lt)}),await Ne.load()),Ne}let St=Y(0);function nn(){const o=Y(0);St=o;const e=Y(!1),n=Y(null),i=Y("mp4");async function s(){const y=Le(),r=Ue();e.value=!0,o.value=0,n.value=null,Be=!1;let u="";try{const D=[];for(const f of y.project.tracks)if(f.type!=="overlay")for(const T of f.clips)D.push({clip:T,mediaId:T.mediaId,trackType:f.type,trackMuted:f.muted,trackVolume:f.volume,trackZIndex:f.zIndex??0});const I=D.filter(f=>!f.trackMuted),J=I.filter(f=>f.trackType==="video").sort((f,T)=>f.trackZIndex-T.trackZIndex);if(I.length===0)throw new Error("All tracks are muted");const Q=i.value,R=y.project.tracks.some(f=>f.type==="overlay"&&!f.muted&&f.overlayClips.length>0),ee=J.length===1&&I.length===1?J[0]:null,ue=ee?ee.clip.crop!=null||ee.clip.blurAreas.length>0:!1,Z=ee?ee.clip.trimStart>.01||ee.clip.trimEnd>.01:!1;if(ee&&!ue&&!Z&&!R){const f=r.items.find(T=>T.id===ee.mediaId);if(f){const T=f.blob.type.includes("webm");if(Q==="webm"&&T||Q==="mp4"&&!T){o.value=50,c(f.blob,`${y.project.name||"export"}.${Q}`),o.value=100;return}}}o.value=2;const U=await tn();o.value=8;const G=new Map,ne=new Set;let me=0;const h=2*1024*1024*1024;for(const f of I){if(G.has(f.mediaId))continue;const T=r.items.find(H=>H.id===f.mediaId);if(!T)continue;if(T.blob.size>h)throw new Error(`File "${T.name}" is too large (${(T.blob.size/1024/1024/1024).toFixed(1)} GB). Browser-based export supports files up to 2 GB. Please trim the clip or use a smaller file.`);const q=T.type==="audio"?"wav":"webm",te=`in${me}.${q}`;try{const H=await Nt(T.blob);await U.writeFile(te,new Uint8Array(H))}catch{throw new Error(`Failed to load "${T.name}" â€“ file may be too large for available memory.`)}G.set(f.mediaId,te),ne.add(te),me++}if(ne.size===0)throw new Error("No media to export");o.value=10;const w=`output.${Q}`;if(ee&&!ue&&!R){const f=G.get(ee.mediaId),T=["-ss",String(ee.clip.trimStart),"-i",f,"-t",String(ee.clip.duration),...v(Q),w];Ke=[],Be=!0;const q=await U.exec(T);if(Be=!1,q!==0)throw new Error(`FFmpeg exited with code ${q}`);await l(U,w,Q,y.project.name,ne);return}const S=Math.max(...I.map(f=>f.clip.startTime+f.clip.duration),1);let $=y.project.stageWidth||1920,d=y.project.stageHeight||1080;$=Math.floor($/2)*2,d=Math.floor(d/2)*2;const b=[...y.project.tracks].filter(f=>f.type==="overlay").sort((f,T)=>(f.zIndex??0)-(T.zIndex??0)),C=[];for(const f of b)C.push(...f.overlayClips);const j=C.length>0,X=C.filter(f=>f.type==="image"&&f.imageData).map(f=>st(f.imageData));if(X.length>0&&await Promise.all(X),j){const T=Math.ceil(S*30),q=document.createElement("canvas");q.width=$,q.height=d;const te=q.getContext("2d");for(let H=0;H<T;H++){const V=H/30,B=C.some(ce=>V>=ce.startTime&&V<ce.startTime+ce.duration);te.clearRect(0,0,$,d),B&&Jt(te,C,V,$,d,1);const re=await(await new Promise(ce=>q.toBlob(ze=>ce(ze),"image/png"))).arrayBuffer(),fe=`frame_${String(H).padStart(5,"0")}.png`;await U.writeFile(fe,new Uint8Array(re)),ne.add(fe),o.value=10+H/T*30}}const be=[],xe=[];for(let f=0;f<I.length;f++){const T=G.get(I[f].mediaId);be.push("-i",T),xe.push(f)}let ye=-1;j&&(ye=I.length,be.push("-framerate","30","-i","frame_%05d.png"));const ve=[];let ge=0;ve.push(`color=c=black:s=${$}x${d}:d=${S}:r=30[base]`);const P=new Map,W=[];for(let f=0;f<J.length;f++){const T=J[f],q=I.indexOf(T),te=T.clip.stageX??0,H=T.clip.stageY??0,V=T.clip.stageW??100,B=T.clip.stageH??100,oe=Math.max(0,Math.floor($*te/100/2)*2),re=Math.max(0,Math.floor(d*H/100/2)*2),fe=Math.max(2,Math.floor($*V/100/2)*2),ce=Math.max(2,Math.floor(d*B/100/2)*2);P.set(f,{x:oe,y:re,w:fe,h:ce});const ze=xe[q],$e=[`trim=start=${T.clip.trimStart}:duration=${T.clip.duration}`,"setpts=PTS-STARTPTS"];if(T.clip.crop){const De=T.clip.crop,m=Math.max(0,Math.min(99,De.x)),x=Math.max(0,Math.min(99,De.y)),z=Math.max(1,Math.min(De.width,100-m)),M=Math.max(1,Math.min(De.height,100-x));$e.push(`crop=round(iw*${z/100}):round(ih*${M/100}):round(iw*${m/100}):round(ih*${x/100})`)}T.clip.startTime>0&&$e.push(`setpts=PTS+${T.clip.startTime}/TB`);const Te=`vb${ge}`;ve.push(`[${ze}:v]${$e.join(",")}[${Te}]`),ge++;let Se=`[${Te}]`;const je=fe,Ye=ce,_e=`vsc${ge}`;ve.push(`${Se}scale=${je}:${Ye}:force_original_aspect_ratio=decrease:force_divisible_by=2[${_e}]`),Se=`[${_e}]`,ge++;for(const De of T.clip.blurAreas){const m=`vbl${ge}`,x=Math.max(0,Math.min(99,De.x)),z=Math.max(0,Math.min(99,De.y)),M=Math.max(1,Math.min(De.width,100-x)),A=Math.max(1,Math.min(De.height,100-z)),ie=`round(iw*${x/100})`,se=`round(ih*${z/100})`,_=`round(iw*${M/100})`,ke=`round(ih*${A/100})`,Ae=`round(W*${x/100})`,Ie=`round(H*${z/100})`,Xe=`sp${ge}a`,tt=`sp${ge}b`;if(ve.push(`${Se}split=2[${Xe}][${tt}]`),De.type==="pixelate"){const Ve=`pxc${ge}`,Je=`pxs${ge}`;ve.push(`[${Xe}]crop=${_}:${ke}:${ie}:${se}[${Ve}]`),ve.push(`[${Ve}]scale=iw/10:ih/10,scale=iw*10:ih*10:flags=neighbor[${Je}]`),ve.push(`[${tt}][${Je}]overlay=${Ae}:${Ie}[${m}]`)}else{const Ve=`blc${ge}`,Je=`bla${ge}`;ve.push(`[${Xe}]crop=${_}:${ke}:${ie}:${se}[${Ve}]`),ve.push(`[${Ve}]boxblur=9:3[${Je}]`),ve.push(`[${tt}][${Je}]overlay=${Ae}:${Ie}[${m}]`)}Se=`[${m}]`,ge++}W.push(Se)}let N="[base]";for(let f=0;f<J.length;f++){const T=J[f],q=`ov${f}`,te=P.get(f),H=`${te.x}+(${te.w}-w)/2`,V=`${te.y}+(${te.h}-h)/2`;ve.push(`${N}${W[f]}overlay=${H}:${V}:enable='between(t,${T.clip.startTime},${T.clip.startTime+T.clip.duration})'[${q}]`),N=`[${q}]`}ve.push(`${N}scale=trunc(iw/2)*2:trunc(ih/2)*2[veven]`);let pe;j?(ve.push(`[veven][${ye}:v]overlay=0:0:format=auto[vfinal]`),pe="[vfinal]"):pe="[veven]";const we=I.filter(f=>f.trackType==="audio"),he=[];let Re=0;for(let f=0;f<we.length;f++){const T=we[f],q=xe[I.indexOf(T)],te=Math.round(T.clip.startTime*1e3),H=`a${Re}`,V=[`atrim=start=${T.clip.trimStart}:duration=${T.clip.duration}`,"asetpts=PTS-STARTPTS"];if(te>0&&V.push(`adelay=${te}|${te}`),T.trackVolume!==1&&V.push(`volume=${T.trackVolume}`),T.clip.fadeIn&&T.clip.fadeIn>0&&V.push(`afade=t=in:d=${T.clip.fadeIn}`),T.clip.fadeOut&&T.clip.fadeOut>0){const B=Math.max(0,T.clip.duration-T.clip.fadeOut);V.push(`afade=t=out:st=${B}:d=${T.clip.fadeOut}`)}ve.push(`[${q}:a]${V.join(",")}[${H}]`),he.push(`[${H}]`),Re++}let a="";const k=he.length>0;he.length===1?a=he[0]:he.length>1&&(ve.push(`${he.join("")}amix=inputs=${he.length}:duration=longest:normalize=0[aout]`),a="[aout]"),u=ve.join(";");const g=[...be,"-filter_complex",u,"-map",pe];k?g.push("-map",a,...v(Q)):g.push("-an",...p(Q)),g.push("-t",String(S),w),Ke=[],lt=j?40:10,$t=95,Be=!0;const O=await U.exec(g);if(Be=!1,O!==0)throw new Error(`FFmpeg exited with code ${O}`);await l(U,w,Q,y.project.name,ne)}catch(D){const I=Ke.filter(R=>!R.startsWith("  configuration:")&&!R.startsWith("  libav")&&!R.startsWith("  libsw")&&!R.startsWith("  libpost")&&!R.startsWith("  built with")&&!R.startsWith("ffmpeg version")&&R.trim()!==""&&R.trim()!=="("&&R.trim()!==")").slice(-15).join(`
`),J=String(D).split(`
`)[0]||"Unknown error";n.value=`${J}
${I}`;const Q=u?`
Filter: ${u.slice(0,600)}`:"";alert(`Export failed: ${J}

${I}${Q}

(Full log in console â€“ F12)`)}finally{Be=!1,e.value=!1}}function v(y){return y==="webm"?["-c:v","libvpx-vp9","-crf","35","-b:v","0","-cpu-used","8","-deadline","realtime","-row-mt","1","-c:a","libopus","-b:a","96k"]:["-c:v","libx264","-preset","ultrafast","-crf","23","-pix_fmt","yuv420p","-c:a","aac","-b:a","128k"]}function p(y){return y==="webm"?["-c:v","libvpx-vp9","-crf","35","-b:v","0","-cpu-used","8","-deadline","realtime","-row-mt","1"]:["-c:v","libx264","-preset","ultrafast","-crf","23","-pix_fmt","yuv420p"]}async function l(y,r,u,D,I){const J=await y.readFile(r);for(const ue of I)try{await y.deleteFile(ue)}catch{}try{await y.deleteFile(r)}catch{}if(o.value=97,!(J instanceof Uint8Array))throw new Error("Unexpected data format");const Q=new Uint8Array(J.length);Q.set(J);const R=u==="webm"?"video/webm":"video/mp4",ee=new Blob([Q],{type:R});c(ee,`${D||"export"}.${u}`),o.value=100}function c(y,r){const u=URL.createObjectURL(y),D=document.createElement("a");D.href=u,D.download=r,D.click(),URL.revokeObjectURL(u)}return{exportProject:s,progress:o,isExporting:e,exportError:n,format:i}}const on={class:"text-sm flex-shrink-0"},rn={class:"flex-1 min-w-0"},sn={class:"text-xs text-zinc-300 truncate"},ln={class:"text-[10px] text-zinc-500"},an=Pe({__name:"MediaItemCard",props:{item:{}},emits:["delete"],setup(o,{emit:e}){const n=o,i=e,s=K(()=>{const l=Math.floor(n.item.duration),c=Math.floor(l/60),y=l%60;return`${c}:${y.toString().padStart(2,"0")}`}),v=K(()=>n.item.type==="video"?"ðŸŽ¬":"ðŸ”Š");function p(l){l.dataTransfer?.setData("application/x-media-id",n.item.id),l.dataTransfer?.setData("application/x-media-type",n.item.type),l.dataTransfer&&(l.dataTransfer.effectAllowed="copy")}return(l,c)=>(E(),L("div",{class:"group flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-zinc-800 cursor-grab active:cursor-grabbing transition-colors",draggable:"true",onDragstart:p},[t("span",on,ae(v.value),1),t("div",rn,[t("p",sn,ae(o.item.name),1),t("p",ln,ae(s.value)+" Â· "+ae(o.item.source),1)]),t("button",{onMousedown:c[0]||(c[0]=le(()=>{},["stop"])),onClick:c[1]||(c[1]=le(y=>i("delete"),["stop"])),draggable:"false",class:"opacity-0 group-hover:opacity-100 w-5 h-5 flex items-center justify-center text-zinc-500 hover:text-red-400 transition-all text-xs",title:"Remove"}," âœ• ",32)],32))}}),un={class:"flex flex-col h-full bg-zinc-900 border-r border-zinc-700"},cn={class:"flex items-center justify-between px-3 py-2 border-b border-zinc-700"},dn={class:"flex-1 overflow-y-auto p-2 space-y-1"},pn={key:0,class:"flex items-center justify-center py-8"},vn={key:1,class:"text-center py-8"},fn=Pe({__name:"MediaLibrary",setup(o){const e=Ue();return ut(()=>e.load()),(n,i)=>(E(),L("div",un,[t("div",cn,[i[1]||(i[1]=t("span",{class:"text-xs font-semibold text-zinc-400 uppercase tracking-wide"},"Media",-1)),t("button",{onClick:i[0]||(i[0]=s=>F(e).importFiles()),class:"px-2 py-1 text-xs bg-cyan-600 hover:bg-cyan-500 rounded font-medium"}," + Import ")]),t("div",dn,[F(e).isLoading?(E(),L("div",pn,[...i[2]||(i[2]=[t("svg",{class:"w-5 h-5 text-zinc-500 animate-spin",fill:"none",viewBox:"0 0 24 24"},[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})],-1)])])):F(e).items.length===0?(E(),L("div",vn,[...i[3]||(i[3]=[t("p",{class:"text-xs text-zinc-500"},"No media files yet.",-1),t("p",{class:"text-xs text-zinc-600 mt-1"},"Import videos or audio, or record a screencast.",-1)])])):de("",!0),(E(!0),L(Ce,null,Ee(F(e).items,s=>(E(),He(an,{key:s.id,item:s,onDelete:v=>F(e).remove(s.id)},null,8,["item","onDelete"]))),128))])]))}}),mn={class:"contents"},yn=["title"],bn=["title"],gn={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 whitespace-nowrap rounded bg-amber-600 px-2 py-0.5 text-[11px] text-white shadow-lg z-50"},xn=Pe({__name:"OverlayHandle",props:{overlay:{},containerWidth:{},containerHeight:{}},setup(o){const e=Le(),n=o,i=K(()=>e.selectedOverlayId===n.overlay.id),s=K(()=>Mt(n.overlay,e.currentTime)),v=K(()=>(n.overlay.keyframes?.length??0)>0),p=K(()=>e.isPlaying||!v.value),l=Y(!1);let c;function y(){e.selectOverlay(n.overlay.id),l.value=!0,clearTimeout(c),c=setTimeout(()=>{l.value=!1},3e3)}const r=K(()=>n.overlay.shape==="arrow"&&n.overlay.p1x!=null&&n.overlay.p1y!=null&&n.overlay.p2x!=null&&n.overlay.p2y!=null),u=K(()=>{const P=s.value;return{left:P.x/100*n.containerWidth+"px",top:P.y/100*n.containerHeight+"px",width:P.width/100*n.containerWidth+"px",height:P.height/100*n.containerHeight+"px"}}),D=Y(!1),I=Y({x:0,y:0,ox:0,oy:0});function J(P){if(P.button!==0)return;if(P.stopPropagation(),P.preventDefault(),!p.value){y();return}e.pushSnapshot(),e.selectOverlay(n.overlay.id),D.value=!0;const W=s.value;I.value={x:P.clientX,y:P.clientY,ox:W.x,oy:W.y},document.addEventListener("mousemove",Q),document.addEventListener("mouseup",R)}function Q(P){if(!D.value)return;const W=P.clientX-I.value.x,N=P.clientY-I.value.y,pe={x:Math.max(0,Math.min(100-n.overlay.width,I.value.ox+W/n.containerWidth*100)),y:Math.max(0,Math.min(100-n.overlay.height,I.value.oy+N/n.containerHeight*100))};e.updateOverlayClip(n.overlay.id,pe),e.isPlaying?e.setKeyframe(n.overlay.id,pe):e.updateKeyframeIfExists(n.overlay.id,pe)}function R(){D.value&&e.isPlaying&&e.setKeyframe(n.overlay.id,{x:n.overlay.x,y:n.overlay.y}),D.value=!1,document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",R)}const ee=Y(!1),ue=Y(""),Z=Y({x:0,y:0,ox:0,oy:0,ow:0,oh:0});function U(P,W){if(P.stopPropagation(),P.preventDefault(),!p.value){y();return}e.pushSnapshot(),ee.value=!0,ue.value=W;const N=s.value;Z.value={x:P.clientX,y:P.clientY,ox:N.x,oy:N.y,ow:N.width,oh:N.height},document.addEventListener("mousemove",G),document.addEventListener("mouseup",ne)}function G(P){if(!ee.value)return;const W=(P.clientX-Z.value.x)/n.containerWidth*100,N=(P.clientY-Z.value.y)/n.containerHeight*100,pe=Z.value,we=ue.value;let he=pe.ox,Re=pe.oy,a=pe.ow,k=pe.oh;we.includes("r")&&(a=Math.max(2,pe.ow+W)),we.includes("l")&&(a=Math.max(2,pe.ow-W),he=pe.ox+W),we.includes("b")&&(k=Math.max(2,pe.oh+N)),we.includes("t")&&(k=Math.max(2,pe.oh-N),Re=pe.oy+N);const g={x:Math.max(0,he),y:Math.max(0,Re),width:Math.min(100,a),height:Math.min(100,k)};e.updateOverlayClip(n.overlay.id,g),e.isPlaying?e.setKeyframe(n.overlay.id,g):e.updateKeyframeIfExists(n.overlay.id,g)}function ne(){ee.value&&e.isPlaying&&e.setKeyframe(n.overlay.id,{x:n.overlay.x,y:n.overlay.y,width:n.overlay.width,height:n.overlay.height}),ee.value=!1,document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",ne)}const me=K(()=>{const P=s.value;return{left:(P.p1x??0)/100*n.containerWidth-7+"px",top:(P.p1y??0)/100*n.containerHeight-7+"px"}}),h=K(()=>{const P=s.value;return{left:(P.p2x??0)/100*n.containerWidth-7+"px",top:(P.p2y??0)/100*n.containerHeight-7+"px"}}),w=K(()=>{const P=s.value,W=(P.p1x??0)/100*n.containerWidth,N=(P.p1y??0)/100*n.containerHeight,pe=(P.p2x??0)/100*n.containerWidth,we=(P.p2y??0)/100*n.containerHeight,he=10;return{left:Math.min(W,pe)-he+"px",top:Math.min(N,we)-he+"px",width:Math.abs(pe-W)+he*2+"px",height:Math.max(Math.abs(we-N),4)+he*2+"px"}}),S=Y(!1),$=Y("p1"),d=Y({cx:0,cy:0,px:0,py:0});function b(P,W){if(P.stopPropagation(),P.preventDefault(),!p.value){y();return}e.pushSnapshot(),e.selectOverlay(n.overlay.id),S.value=!0,$.value=W;const N=s.value,pe=W==="p1"?N.p1x??0:N.p2x??0,we=W==="p1"?N.p1y??0:N.p2y??0;d.value={cx:P.clientX,cy:P.clientY,px:pe,py:we},document.addEventListener("mousemove",C),document.addEventListener("mouseup",j)}function C(P){if(!S.value)return;const W=(P.clientX-d.value.cx)/n.containerWidth*100,N=(P.clientY-d.value.cy)/n.containerHeight*100,pe=Math.max(0,Math.min(100,d.value.px+W)),we=Math.max(0,Math.min(100,d.value.py+N)),he=$.value==="p1"?{p1x:pe,p1y:we}:{p2x:pe,p2y:we};e.updateOverlayClip(n.overlay.id,he),e.isPlaying?e.setKeyframe(n.overlay.id,he):e.updateKeyframeIfExists(n.overlay.id,he)}function j(){if(S.value&&e.isPlaying){const P=n.overlay;e.setKeyframe(P.id,{p1x:P.p1x,p1y:P.p1y,p2x:P.p2x,p2y:P.p2y})}S.value=!1,document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",j)}const X=Y(!1),be=Y({cx:0,cy:0,p1x:0,p1y:0,p2x:0,p2y:0});function xe(P){if(P.stopPropagation(),P.preventDefault(),!p.value){y();return}e.pushSnapshot(),e.selectOverlay(n.overlay.id),X.value=!0;const W=s.value;be.value={cx:P.clientX,cy:P.clientY,p1x:W.p1x??0,p1y:W.p1y??0,p2x:W.p2x??0,p2y:W.p2y??0},document.addEventListener("mousemove",ye),document.addEventListener("mouseup",ve)}function ye(P){if(!X.value)return;const W=(P.clientX-be.value.cx)/n.containerWidth*100,N=(P.clientY-be.value.cy)/n.containerHeight*100,pe=be.value,we={p1x:Math.max(0,Math.min(100,pe.p1x+W)),p1y:Math.max(0,Math.min(100,pe.p1y+N)),p2x:Math.max(0,Math.min(100,pe.p2x+W)),p2y:Math.max(0,Math.min(100,pe.p2y+N))};e.updateOverlayClip(n.overlay.id,we),e.isPlaying?e.setKeyframe(n.overlay.id,we):e.updateKeyframeIfExists(n.overlay.id,we)}function ve(){if(X.value&&e.isPlaying){const P=n.overlay;e.setKeyframe(P.id,{p1x:P.p1x,p1y:P.p1y,p2x:P.p2x,p2y:P.p2y})}X.value=!1,document.removeEventListener("mousemove",ye),document.removeEventListener("mouseup",ve)}function ge(P){P.stopPropagation(),e.selectOverlay(n.overlay.id)}return(P,W)=>(E(),L("div",mn,[r.value?(E(),L(Ce,{key:0},[t("div",{class:Me(["absolute pointer-events-auto",[i.value?"z-20":"z-10",p.value?"cursor-move":"cursor-not-allowed"]]),style:Oe(w.value),title:p.value?void 0:"Has keyframes â€“ play to record or delete keyframes to reposition",onMousedown:xe,onClick:ge},null,46,yn),t("div",{class:Me(["absolute w-3.5 h-3.5 rounded-full pointer-events-auto z-30 ring-2 ring-white",[i.value?"bg-cyan-400 shadow-lg":"bg-white/40 hover:bg-white/70",p.value?"cursor-grab":"cursor-not-allowed"]]),style:Oe(me.value),onMousedown:W[0]||(W[0]=N=>b(N,"p1"))},null,38),t("div",{class:Me(["absolute w-3.5 h-3.5 rounded-full pointer-events-auto z-30 ring-2 ring-white",[i.value?"bg-red-400 shadow-lg":"bg-white/40 hover:bg-white/70",p.value?"cursor-grab":"cursor-not-allowed"]]),style:Oe(h.value),onMousedown:W[1]||(W[1]=N=>b(N,"p2"))},null,38)],64)):(E(),L("div",{key:1,class:Me(["absolute pointer-events-auto",i.value?"z-20":"z-10"]),style:Oe(u.value),title:p.value?void 0:"Has keyframes â€“ play to record or delete keyframes to reposition",onMousedown:J},[t("div",{class:Me(["w-full h-full border-2 rounded-sm",[i.value?"border-cyan-400":"border-transparent hover:border-white/30",p.value?"cursor-move":"cursor-not-allowed"]])},null,2),l.value&&i.value?(E(),L("div",gn," Delete keyframes or play to reposition ")):de("",!0),i.value&&p.value?(E(),L(Ce,{key:1},[t("div",{class:"absolute -top-1 -left-1 w-2.5 h-2.5 bg-cyan-400 rounded-sm cursor-nw-resize",onMousedown:W[2]||(W[2]=le(N=>U(N,"tl"),["stop"]))},null,32),t("div",{class:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-cyan-400 rounded-sm cursor-ne-resize",onMousedown:W[3]||(W[3]=le(N=>U(N,"tr"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1 -left-1 w-2.5 h-2.5 bg-cyan-400 rounded-sm cursor-sw-resize",onMousedown:W[4]||(W[4]=le(N=>U(N,"bl"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1 -right-1 w-2.5 h-2.5 bg-cyan-400 rounded-sm cursor-se-resize",onMousedown:W[5]||(W[5]=le(N=>U(N,"br"),["stop"]))},null,32),t("div",{class:"absolute -top-1 left-1/2 -translate-x-1/2 w-2.5 h-1.5 bg-cyan-400 rounded-sm cursor-n-resize",onMousedown:W[6]||(W[6]=le(N=>U(N,"t"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-1.5 bg-cyan-400 rounded-sm cursor-s-resize",onMousedown:W[7]||(W[7]=le(N=>U(N,"b"),["stop"]))},null,32),t("div",{class:"absolute top-1/2 -left-1 -translate-y-1/2 w-1.5 h-2.5 bg-cyan-400 rounded-sm cursor-w-resize",onMousedown:W[8]||(W[8]=le(N=>U(N,"l"),["stop"]))},null,32),t("div",{class:"absolute top-1/2 -right-1 -translate-y-1/2 w-1.5 h-2.5 bg-cyan-400 rounded-sm cursor-e-resize",onMousedown:W[9]||(W[9]=le(N=>U(N,"r"),["stop"]))},null,32)],64)):de("",!0)],46,bn))]))}}),hn=["onMousedown"],wn=["onMousedown"],kn=["onMousedown"],zn=["onMousedown"],Mn=["onMousedown"],Tn=["onMousedown"],Cn=["onMousedown"],$n=["onMousedown"],Sn=["onMousedown"],In={class:"absolute -top-4 left-0 text-[9px] text-red-400 font-semibold select-none pointer-events-none uppercase"},En=Pe({__name:"ClipEffectHandle",props:{clip:{},videoX:{},videoY:{},videoW:{},videoH:{},containerWidth:{},containerHeight:{}},setup(o){const e=Le(),n=o,i=K(()=>e.selectedClipId===n.clip.id),s=K(()=>n.clip.crop?{left:n.videoX+n.clip.crop.x/100*n.videoW+"px",top:n.videoY+n.clip.crop.y/100*n.videoH+"px",width:n.clip.crop.width/100*n.videoW+"px",height:n.clip.crop.height/100*n.videoH+"px"}:null),v=Y(!1),p=Y(""),l=Y({cx:0,cy:0,ox:0,oy:0,ow:0,oh:0});function c(b,C){if(!n.clip.crop)return;b.stopPropagation(),b.preventDefault(),e.pushSnapshot(),v.value=!0,p.value=C;const j=n.clip.crop;l.value={cx:b.clientX,cy:b.clientY,ox:j.x,oy:j.y,ow:j.width,oh:j.height},document.addEventListener("mousemove",y),document.addEventListener("mouseup",r)}function y(b){if(!v.value||!n.clip.crop)return;const C=l.value,j=p.value,X=100/n.videoW,be=100/n.videoH,xe=(b.clientX-C.cx)*X,ye=(b.clientY-C.cy)*be;let ve=C.ox,ge=C.oy,P=C.ow,W=C.oh;j.includes("r")&&(P=Math.max(5,Math.min(100-ve,C.ow+xe))),j.includes("l")&&(P=Math.max(5,C.ow-xe),ve=Math.max(0,Math.min(C.ox+C.ow-5,C.ox+xe))),j.includes("b")&&(W=Math.max(5,Math.min(100-ge,C.oh+ye))),j.includes("t")&&(W=Math.max(5,C.oh-ye),ge=Math.max(0,Math.min(C.oy+C.oh-5,C.oy+ye))),e.setCrop(n.clip.id,{x:ve,y:ge,width:P,height:W})}function r(){v.value=!1,document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",r)}const u=Y(!1),D=Y({cx:0,cy:0,ox:0,oy:0});function I(b){b.button!==0||!n.clip.crop||(b.stopPropagation(),b.preventDefault(),e.pushSnapshot(),u.value=!0,D.value={cx:b.clientX,cy:b.clientY,ox:n.clip.crop.x,oy:n.clip.crop.y},document.addEventListener("mousemove",J),document.addEventListener("mouseup",Q))}function J(b){if(!u.value||!n.clip.crop)return;const C=n.clip.crop,j=100/n.videoW,X=100/n.videoH,be=(b.clientX-D.value.cx)*j,xe=(b.clientY-D.value.cy)*X;e.setCrop(n.clip.id,{...C,x:Math.max(0,Math.min(100-C.width,D.value.ox+be)),y:Math.max(0,Math.min(100-C.height,D.value.oy+xe))})}function Q(){u.value=!1,document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",Q)}function R(b){return{left:n.videoX+b.x/100*n.videoW+"px",top:n.videoY+b.y/100*n.videoH+"px",width:b.width/100*n.videoW+"px",height:b.height/100*n.videoH+"px"}}const ee=Y(null),ue=Y({cx:0,cy:0,ox:0,oy:0});function Z(b,C){b.button===0&&(b.stopPropagation(),b.preventDefault(),e.pushSnapshot(),e.selectClip(n.clip.id),ee.value=C.id,ue.value={cx:b.clientX,cy:b.clientY,ox:C.x,oy:C.y},document.addEventListener("mousemove",U),document.addEventListener("mouseup",G))}function U(b){if(!ee.value)return;const C=n.clip.blurAreas.find(be=>be.id===ee.value);if(!C)return;const j=(b.clientX-ue.value.cx)/n.videoW*100,X=(b.clientY-ue.value.cy)/n.videoH*100;e.updateBlurArea(n.clip.id,C.id,{x:Math.max(0,Math.min(100-C.width,ue.value.ox+j)),y:Math.max(0,Math.min(100-C.height,ue.value.oy+X))})}function G(){ee.value=null,document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",G)}const ne=Y(null),me=Y(""),h=Y({cx:0,cy:0,ox:0,oy:0,ow:0,oh:0});function w(b,C,j){b.stopPropagation(),b.preventDefault(),e.pushSnapshot(),ne.value=C.id,me.value=j,h.value={cx:b.clientX,cy:b.clientY,ox:C.x,oy:C.y,ow:C.width,oh:C.height},document.addEventListener("mousemove",S),document.addEventListener("mouseup",$)}function S(b){if(!ne.value)return;const C=(b.clientX-h.value.cx)/n.videoW*100,j=(b.clientY-h.value.cy)/n.videoH*100,X=h.value,be=me.value;let xe=X.ox,ye=X.oy,ve=X.ow,ge=X.oh;be.includes("r")&&(ve=Math.max(1,Math.min(100-xe,X.ow+C))),be.includes("l")&&(ve=Math.max(1,X.ow-C),xe=Math.max(0,X.ox+C)),be.includes("b")&&(ge=Math.max(1,Math.min(100-ye,X.oh+j))),be.includes("t")&&(ge=Math.max(1,X.oh-j),ye=Math.max(0,X.oy+j)),e.updateBlurArea(n.clip.id,ne.value,{x:xe,y:ye,width:ve,height:ge})}function $(){ne.value=null,document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",$)}function d(b){b.stopPropagation(),e.selectClip(n.clip.id)}return(b,C)=>i.value?(E(),L("div",{key:0,class:"contents",onClick:d},[o.clip.crop?(E(),L("div",{key:0,class:"absolute z-20 pointer-events-auto",style:Oe(s.value)},[t("div",{class:"w-full h-full border border-yellow-400/40 cursor-grab active:cursor-grabbing",onMousedown:I},null,32),t("div",{class:"absolute -top-1.5 -left-1.5 w-3 h-3 bg-yellow-400 rounded-sm cursor-nw-resize",onMousedown:C[0]||(C[0]=le(j=>c(j,"tl"),["stop"]))},null,32),t("div",{class:"absolute -top-1.5 -right-1.5 w-3 h-3 bg-yellow-400 rounded-sm cursor-ne-resize",onMousedown:C[1]||(C[1]=le(j=>c(j,"tr"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1.5 -left-1.5 w-3 h-3 bg-yellow-400 rounded-sm cursor-sw-resize",onMousedown:C[2]||(C[2]=le(j=>c(j,"bl"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1.5 -right-1.5 w-3 h-3 bg-yellow-400 rounded-sm cursor-se-resize",onMousedown:C[3]||(C[3]=le(j=>c(j,"br"),["stop"]))},null,32),t("div",{class:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-1.5 bg-yellow-400 rounded-sm cursor-n-resize",onMousedown:C[4]||(C[4]=le(j=>c(j,"t"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-1.5 bg-yellow-400 rounded-sm cursor-s-resize",onMousedown:C[5]||(C[5]=le(j=>c(j,"b"),["stop"]))},null,32),t("div",{class:"absolute top-1/2 -left-1.5 -translate-y-1/2 w-1.5 h-3 bg-yellow-400 rounded-sm cursor-w-resize",onMousedown:C[6]||(C[6]=le(j=>c(j,"l"),["stop"]))},null,32),t("div",{class:"absolute top-1/2 -right-1.5 -translate-y-1/2 w-1.5 h-3 bg-yellow-400 rounded-sm cursor-e-resize",onMousedown:C[7]||(C[7]=le(j=>c(j,"r"),["stop"]))},null,32),C[8]||(C[8]=t("span",{class:"absolute -top-5 left-0 text-[9px] text-yellow-400 font-semibold select-none pointer-events-none"},"CROP",-1))],4)):de("",!0),(E(!0),L(Ce,null,Ee(o.clip.blurAreas,j=>(E(),L("div",{key:j.id,class:"absolute z-20 pointer-events-auto",style:Oe(R(j))},[t("div",{class:Me(["w-full h-full border-2 border-red-400/80 cursor-move",j.type==="pixelate"?"border-dotted":"border-dashed"]),style:{backgroundColor:"rgba(239,68,68,0.08)"},onMousedown:X=>Z(X,j)},null,42,hn),t("div",{class:"absolute -top-1.5 -left-1.5 w-3 h-3 bg-red-400 rounded-sm cursor-nw-resize",onMousedown:le(X=>w(X,j,"tl"),["stop"])},null,40,wn),t("div",{class:"absolute -top-1.5 -right-1.5 w-3 h-3 bg-red-400 rounded-sm cursor-ne-resize",onMousedown:le(X=>w(X,j,"tr"),["stop"])},null,40,kn),t("div",{class:"absolute -bottom-1.5 -left-1.5 w-3 h-3 bg-red-400 rounded-sm cursor-sw-resize",onMousedown:le(X=>w(X,j,"bl"),["stop"])},null,40,zn),t("div",{class:"absolute -bottom-1.5 -right-1.5 w-3 h-3 bg-red-400 rounded-sm cursor-se-resize",onMousedown:le(X=>w(X,j,"br"),["stop"])},null,40,Mn),t("div",{class:"absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-1.5 bg-red-400 rounded-sm cursor-n-resize",onMousedown:le(X=>w(X,j,"t"),["stop"])},null,40,Tn),t("div",{class:"absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-1.5 bg-red-400 rounded-sm cursor-s-resize",onMousedown:le(X=>w(X,j,"b"),["stop"])},null,40,Cn),t("div",{class:"absolute top-1/2 -left-1.5 -translate-y-1/2 w-1.5 h-3 bg-red-400 rounded-sm cursor-w-resize",onMousedown:le(X=>w(X,j,"l"),["stop"])},null,40,$n),t("div",{class:"absolute top-1/2 -right-1.5 -translate-y-1/2 w-1.5 h-3 bg-red-400 rounded-sm cursor-e-resize",onMousedown:le(X=>w(X,j,"r"),["stop"])},null,40,Sn),t("span",In,ae(j.type),1)],4))),128))])):de("",!0)}}),Dn={class:"absolute -top-5 right-0 text-[9px] text-blue-300 bg-zinc-900/80 px-1 rounded select-none pointer-events-none tabular-nums"},An=Pe({__name:"VideoClipHandle",props:{clip:{},boundsX:{},boundsY:{},boundsW:{},boundsH:{},containerWidth:{},containerHeight:{}},setup(o){const e=Le(),n=o,i=K(()=>e.selectedClipId===n.clip.id),s=K(()=>({left:n.boundsX+"px",top:n.boundsY+"px",width:n.boundsW+"px",height:n.boundsH+"px"})),v=Y(!1),p=Y({cx:0,cy:0,ox:0,oy:0});function l(Z){Z.button===0&&(Z.stopPropagation(),Z.preventDefault(),e.pushSnapshot(),e.selectClip(n.clip.id),v.value=!0,p.value={cx:Z.clientX,cy:Z.clientY,ox:n.clip.stageX??0,oy:n.clip.stageY??0},document.addEventListener("mousemove",c),document.addEventListener("mouseup",y))}function c(Z){if(!v.value)return;const U=(Z.clientX-p.value.cx)/n.containerWidth*100,G=(Z.clientY-p.value.cy)/n.containerHeight*100,ne=Math.max(-50,Math.min(100,p.value.ox+U)),me=Math.max(-50,Math.min(100,p.value.oy+G));R({stageX:ne,stageY:me,stageW:n.clip.stageW??100,stageH:n.clip.stageH??100})}function y(){v.value=!1,document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",y)}const r=Y(!1),u=Y(""),D=Y({cx:0,cy:0,ox:0,oy:0,ow:0,oh:0});function I(Z,U){Z.stopPropagation(),Z.preventDefault(),e.pushSnapshot(),r.value=!0,u.value=U,D.value={cx:Z.clientX,cy:Z.clientY,ox:n.clip.stageX??0,oy:n.clip.stageY??0,ow:n.clip.stageW??100,oh:n.clip.stageH??100},document.addEventListener("mousemove",J),document.addEventListener("mouseup",Q)}function J(Z){if(!r.value)return;const U=(Z.clientX-D.value.cx)/n.containerWidth*100,G=(Z.clientY-D.value.cy)/n.containerHeight*100,ne=D.value,me=u.value;let h=ne.ox,w=ne.oy,S=ne.ow,$=ne.oh;me.includes("r")&&(S=Math.max(5,ne.ow+U)),me.includes("l")&&(S=Math.max(5,ne.ow-U),h=ne.ox+U),me.includes("b")&&($=Math.max(5,ne.oh+G)),me.includes("t")&&($=Math.max(5,ne.oh-G),w=ne.oy+G),R({stageX:h,stageY:w,stageW:S,stageH:$})}function Q(){r.value=!1,document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",Q)}function R(Z){for(const U of e.project.tracks){const G=U.clips.find(ne=>ne.id===n.clip.id);if(G){Object.assign(G,Z);return}}}const ee=K(()=>{const Z=e.project.stageWidth||1920,U=e.project.stageHeight||1080;return{w:Math.round((n.clip.stageW??100)/100*Z),h:Math.round((n.clip.stageH??100)/100*U)}});function ue(Z){Z.stopPropagation(),e.selectClip(n.clip.id)}return(Z,U)=>i.value?(E(),L("div",{key:0,class:"absolute z-10 pointer-events-auto",style:Oe(s.value),onClick:ue},[t("div",{class:"w-full h-full border-2 border-blue-400/60 cursor-move rounded-sm",onMousedown:l},null,32),t("div",{class:"absolute -top-1 -left-1 w-2.5 h-2.5 bg-blue-400 rounded-sm cursor-nw-resize",onMousedown:U[0]||(U[0]=le(G=>I(G,"tl"),["stop"]))},null,32),t("div",{class:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-blue-400 rounded-sm cursor-ne-resize",onMousedown:U[1]||(U[1]=le(G=>I(G,"tr"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1 -left-1 w-2.5 h-2.5 bg-blue-400 rounded-sm cursor-sw-resize",onMousedown:U[2]||(U[2]=le(G=>I(G,"bl"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1 -right-1 w-2.5 h-2.5 bg-blue-400 rounded-sm cursor-se-resize",onMousedown:U[3]||(U[3]=le(G=>I(G,"br"),["stop"]))},null,32),t("div",{class:"absolute -top-1 left-1/2 -translate-x-1/2 w-2.5 h-1.5 bg-blue-400 rounded-sm cursor-n-resize",onMousedown:U[4]||(U[4]=le(G=>I(G,"t"),["stop"]))},null,32),t("div",{class:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-1.5 bg-blue-400 rounded-sm cursor-s-resize",onMousedown:U[5]||(U[5]=le(G=>I(G,"b"),["stop"]))},null,32),t("div",{class:"absolute top-1/2 -left-1 -translate-y-1/2 w-1.5 h-2.5 bg-blue-400 rounded-sm cursor-w-resize",onMousedown:U[6]||(U[6]=le(G=>I(G,"l"),["stop"]))},null,32),t("div",{class:"absolute top-1/2 -right-1 -translate-y-1/2 w-1.5 h-2.5 bg-blue-400 rounded-sm cursor-e-resize",onMousedown:U[7]||(U[7]=le(G=>I(G,"r"),["stop"]))},null,32),U[8]||(U[8]=t("span",{class:"absolute -top-5 left-0 text-[9px] text-blue-400 font-semibold select-none pointer-events-none"},"VIDEO",-1)),t("span",Dn,ae(ee.value.w)+" Ã— "+ae(ee.value.h),1)],4)):de("",!0)}}),Pn={class:"flex flex-col items-center h-full bg-black p-4 gap-3"},Ln={key:0,class:"absolute -top-8 left-1/2 -translate-x-1/2 flex items-center gap-1 z-30"},On={class:"absolute inset-0 pointer-events-none overflow-hidden"},jn={class:"flex items-center gap-2 shrink-0"},Rn={key:0,class:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24"},Wn={key:1,class:"w-5 h-5 ml-0.5",fill:"currentColor",viewBox:"0 0 24 24"},Hn={class:"text-sm font-mono text-zinc-400 ml-2"},Un=Pe({__name:"VideoPreview",setup(o){const e=Le(),n=Ue(),i=Y(null),s=Y(null),v=Y(640),p=Y(360),l=Y(640),c=Y(400),y=K(()=>{const a=e.project.stageWidth||1920,k=e.project.stageHeight||1080,g=a/k,O=l.value,f=c.value;if(O<=0||f<=0)return{width:"640px",height:"360px"};let T,q;return g>O/f?(T=O,q=O/g):(q=f,T=f*g),{width:`${Math.round(T)}px`,height:`${Math.round(q)}px`}}),r=K(()=>{const a=e.currentTime,k=[];for(const g of e.project.tracks)if(g.type==="overlay")for(const O of g.overlayClips)a>=O.startTime&&a<O.startTime+O.duration&&k.push(O);return k});function u(){I.value||r.value.some(a=>a.id===e.selectedOverlayId)||e.clearSelection()}function D(){e.editMode="crop";const a=I.value;a&&!a.crop&&(e.pushSnapshot(),e.setCrop(a.id,{x:0,y:0,width:100,height:100}))}const I=K(()=>{const a=e.selectedClip;if(!a||!e.selectedTrackId)return null;const k=e.project.tracks.find(O=>O.id===e.selectedTrackId);if(!k||k.type!=="video")return null;const g=e.currentTime;return g<a.startTime||g>=a.startTime+a.duration?null:a}),J=K(()=>{const a=I.value;if(!a)return{x:0,y:0,w:v.value,h:p.value};const k=ne.get(a.id),g=k?.videoWidth||1920,O=k?.videoHeight||1080,f=e.project.stageWidth||1920,T=e.project.stageHeight||1080,q=(a.stageX??0)/100*f,te=(a.stageY??0)/100*T,H=(a.stageW??100)/100*f,V=(a.stageH??100)/100*T,B=g/O,oe=H/V;let re,fe,ce,ze;B>oe?(ce=H,ze=H/B,re=q,fe=te+(V-ze)/2):(ze=V,ce=V*B,re=q+(H-ce)/2,fe=te);const $e=v.value/f,Te=p.value/T;return{x:re*$e,y:fe*Te,w:ce*$e,h:ze*Te}}),Q=K(()=>{if(e.editMode==="crop")return J.value;const a=I.value;if(!a)return{x:0,y:0,w:v.value,h:p.value};const k=ne.get(a.id),g=k?.videoWidth||1920,O=k?.videoHeight||1080,f=a.crop?g*(a.crop.width/100):g,T=a.crop?O*(a.crop.height/100):O,q=e.project.stageWidth||1920,te=e.project.stageHeight||1080,H=(a.stageX??0)/100*q,V=(a.stageY??0)/100*te,B=(a.stageW??100)/100*q,oe=(a.stageH??100)/100*te,re=f/T,fe=B/oe;let ce,ze,$e,Te;re>fe?($e=B,Te=B/re,ce=H,ze=V+(oe-Te)/2):(Te=oe,$e=oe*re,ce=H+(B-$e)/2,ze=V);const Se=v.value/q,je=p.value/te;return{x:ce*Se,y:ze*je,w:$e*Se,h:Te*je}}),R=K(()=>{const a=I.value;if(!a)return null;const k=e.project.stageWidth||1920,g=e.project.stageHeight||1080,O=v.value/k,f=p.value/g;return{x:(a.stageX??0)/100*k*O,y:(a.stageY??0)/100*g*f,w:(a.stageW??100)/100*k*O,h:(a.stageH??100)/100*g*f}});let ee=1280,ue=720,Z=null,U=null;function G(){const a=i.value;if(!a)return;const k=window.devicePixelRatio||1,g=a.clientWidth,O=a.clientHeight;if(g===0||O===0)return;const f=Math.round(g*k),T=Math.round(O*k);(a.width!==f||a.height!==T)&&(a.width=f,a.height=T),ee=f,ue=T}const ne=new Map,me=new Map;let h=null,w=null,S=null;const $=new Map;function d(a,k){if(ne.has(a))return ne.get(a);const g=n.items.find(T=>T.id===k);if(!g||g.type!=="video")return null;const O=URL.createObjectURL(g.blob),f=document.createElement("video");return f.src=O,f.preload="auto",f.playsInline=!0,ne.set(a,f),C(a,f),f}function b(a,k){if(me.has(a))return me.get(a);const g=n.items.find(T=>T.id===k);if(!g||g.type!=="audio"&&g.type!=="video")return null;const O=URL.createObjectURL(g.blob),f=document.createElement("audio");return f.src=O,f.preload="auto",f.crossOrigin="anonymous",me.set(a,f),C(a,f),f}function C(a,k){if(!$.has(a)){S||(S=new AudioContext);try{const g=S.createMediaElementSource(k),O=S.createGain();O.gain.value=0,g.connect(O),O.connect(S.destination),$.set(a,{source:g,gain:O})}catch{}}}function j(a,k,g,O,f,T){const q=a/k,te=f/T;let H,V,B,oe;return q>te?(H=f,V=f/q,B=g,oe=O+(T-V)/2):(V=T,H=T*q,B=g+(f-H)/2,oe=O),{dx:B,dy:oe,dw:H,dh:V}}function X(a){return{x:(a.stageX??0)/100*ee,y:(a.stageY??0)/100*ue,w:(a.stageW??100)/100*ee,h:(a.stageH??100)/100*ue}}function be(a,k,g){const O=X(g),f=k.videoWidth||ee,T=k.videoHeight||ue;if(e.editMode==="crop"&&e.selectedClipId===g.id){const{dx:te,dy:H,dw:V,dh:B}=j(f,T,O.x,O.y,O.w,O.h);if(a.drawImage(k,0,0,f,T,te,H,V,B),g.crop){const oe=te+g.crop.x/100*V,re=H+g.crop.y/100*B,fe=g.crop.width/100*V,ce=g.crop.height/100*B;a.save(),a.fillStyle="rgba(0, 0, 0, 0.6)",a.fillRect(te,H,V,re-H),a.fillRect(te,re+ce,V,H+B-(re+ce)),a.fillRect(te,re,oe-te,ce),a.fillRect(oe+fe,re,te+V-(oe+fe),ce),a.restore()}g.blurAreas.length>0&&xe(a,k,g,0,0,f,T,te,H,V,B)}else{let te=0,H=0,V=f,B=T;g.crop&&(te=g.crop.x/100*f,H=g.crop.y/100*T,V=g.crop.width/100*f,B=g.crop.height/100*T);const{dx:oe,dy:re,dw:fe,dh:ce}=j(V,B,O.x,O.y,O.w,O.h);a.drawImage(k,te,H,V,B,oe,re,fe,ce),g.blurAreas.length>0&&xe(a,k,g,te,H,V,B,oe,re,fe,ce)}}function xe(a,k,g,O,f,T,q,te,H,V,B){for(const oe of g.blurAreas){const re=te+oe.x/100*V,fe=H+oe.y/100*B,ce=oe.width/100*V,ze=oe.height/100*B;if(oe.type==="pixelate"){const Te=document.createElement("canvas"),Se=Math.max(1,Math.round(ce/10)),je=Math.max(1,Math.round(ze/10));Te.width=Se,Te.height=je;const Ye=Te.getContext("2d");Ye.imageSmoothingEnabled=!1;const _e=O+oe.x/100*T,De=f+oe.y/100*q,m=oe.width/100*T,x=oe.height/100*q;Ye.drawImage(k,_e,De,m,x,0,0,Se,je),a.imageSmoothingEnabled=!1,a.drawImage(Te,re,fe,ce,ze),a.imageSmoothingEnabled=!0}else{a.save(),a.beginPath(),a.rect(re,fe,ce,ze),a.clip(),a.filter="blur(12px)";const $e=O+oe.x/100*T,Te=f+oe.y/100*q,Se=oe.width/100*T,je=oe.height/100*q;a.drawImage(k,$e-Se*.1,Te-je*.1,Se*1.2,je*1.2,re-ce*.1,fe-ze*.1,ce*1.2,ze*1.2),a.restore()}}}function ye(){G();const a=i.value?.getContext("2d");if(!a)return;const k=e.currentTime,g=e.project.tracks,O=[];let f=!1;for(const H of g){if(H.muted)continue;const V=H.zIndex??0;if(H.type==="video")for(const B of H.clips){if(k<B.startTime||k>=B.startTime+B.duration)continue;const oe=n.items.find(ce=>ce.id===B.mediaId);if(!oe||oe.type!=="video")continue;const re=d(B.id,B.mediaId);if(!re)continue;const fe=k-B.startTime+B.trimStart;e.isPlaying?re.paused?(re.currentTime=fe,re.play().catch(()=>{})):Math.abs(re.currentTime-fe)>.3&&(re.currentTime=fe):Math.abs(re.currentTime-fe)>.05&&(re.currentTime=fe),re.readyState>=2&&(O.push({type:"video",video:re,clip:B,z:V}),f=!0)}if(H.type==="audio")for(const B of H.clips){if(k<B.startTime||k>=B.startTime+B.duration){const fe=me.get(B.id);fe&&!fe.paused&&fe.pause();continue}const oe=b(B.id,B.mediaId);if(!oe)continue;const re=k-B.startTime+B.trimStart;e.isPlaying?oe.paused?(oe.currentTime=re,oe.play().catch(()=>{})):Math.abs(oe.currentTime-re)>.3&&(oe.currentTime=re):Math.abs(oe.currentTime-re)>.05&&(oe.currentTime=re)}if(H.type==="overlay")for(const B of H.overlayClips)k>=B.startTime&&k<B.startTime+B.duration&&O.push({type:"overlay",oc:B,z:V})}O.sort((H,V)=>H.z-V.z);const T=g.some(H=>H.type==="video"&&!H.muted&&H.clips.some(V=>k>=V.startTime&&k<V.startTime+V.duration)),q=O.some(H=>H.type==="overlay");if(!T||f||q){a.resetTransform(),a.globalAlpha=1,a.globalCompositeOperation="source-over",a.filter="none",a.imageSmoothingEnabled=!0,a.fillStyle="#000",a.fillRect(0,0,ee,ue);for(const H of O){a.save();try{H.type==="video"?be(a,H.video,H.clip):we(a,H.oc,k)}catch{}a.restore()}}pe(k)}function ve(a){if(!e.isPlaying){h=null,w=null;return}if(w!==null){const k=(a-w)/1e3,g=Math.min(k,.1);e.currentTime=e.currentTime+g}if(w=a,e.currentTime>=e.projectDuration){P(),e.seek(0);return}ye(),h=requestAnimationFrame(ve)}function ge(){S||(S=new AudioContext),S.resume();const a=e.currentTime;for(const k of e.project.tracks)if(k.type!=="overlay")for(const g of k.clips){if(a<g.startTime||a>=g.startTime+g.duration)continue;const O=a-g.startTime+g.trimStart;if(k.type==="video"){const f=d(g.id,g.mediaId);f&&(f.currentTime=O,f.play().catch(()=>{}))}if(k.type==="audio"){const f=b(g.id,g.mediaId);f&&(f.currentTime=O,f.play().catch(()=>{}))}}S.resume(),w=null,h=requestAnimationFrame(ve)}function P(){h&&(cancelAnimationFrame(h),h=null),w=null;const a=e.currentTime,k=[];for(const g of e.project.tracks)if(g.type!=="overlay")for(const O of g.clips){if(a<O.startTime||a>=O.startTime+O.duration)continue;const f=a-O.startTime+O.trimStart,T=ne.get(O.id);T&&(T.pause(),Math.abs(T.currentTime-f)>.05&&(T.currentTime=f,k.push(new Promise(te=>{T.addEventListener("seeked",()=>te(),{once:!0}),setTimeout(te,200)}))));const q=me.get(O.id);q&&(q.pause(),Math.abs(q.currentTime-f)>.05&&(q.currentTime=f))}for(const g of ne.values())g.paused||g.pause();for(const g of me.values())g.paused||g.pause();k.length>0?Promise.all(k).then(()=>ye()):ye()}function W(){e.setPlaying(!e.isPlaying)}Fe(()=>e.isPlaying,a=>{a?ge():P()});let N=null;Fe(()=>e.currentTime,()=>{e.isPlaying||(ye(),N&&clearTimeout(N),N=setTimeout(ye,100))}),Fe(()=>e.project.tracks,()=>{e.isPlaying||ye()},{deep:!0}),Fe(()=>e.editMode,()=>{e.isPlaying||ye()}),Fe(()=>[e.project.stageWidth,e.project.stageHeight],()=>{e.isPlaying||Et(()=>{G(),he(),ye()})});function pe(a){for(const k of e.project.tracks)if(k.type!=="overlay")for(const g of k.clips){const O=$.get(g.id);if(!O)continue;if(!(a>=g.startTime&&a<g.startTime+g.duration)||k.muted){O.gain.gain.value=0;continue}let T=1;const q=a-g.startTime;if(g.fadeIn&&g.fadeIn>0&&q<g.fadeIn&&(T=q/g.fadeIn),g.fadeOut&&g.fadeOut>0){const te=g.duration-g.fadeOut;q>te&&(T=Math.min(T,(g.duration-q)/g.fadeOut))}O.gain.gain.value=k.volume*Math.max(0,Math.min(1,T))}}function we(a,k,g){const O=ee/(e.project.stageWidth||1920);Ct(a,k,g,ee,ue,O)}function he(){const a=i.value;a&&(v.value=a.clientWidth,p.value=a.clientHeight)}ut(()=>{i.value&&(Z=new ResizeObserver(()=>{G(),he(),e.isPlaying||ye()}),Z.observe(i.value)),s.value&&(U=new ResizeObserver(a=>{const k=a[0];k&&(l.value=k.contentRect.width,c.value=k.contentRect.height)}),U.observe(s.value)),ft(()=>{e.isPlaying||ye()}),setTimeout(()=>{he(),ye()},100)}),wt(()=>{ft(null),Z?.disconnect(),U?.disconnect(),P();for(const[,a]of ne)a.pause(),a.src&&URL.revokeObjectURL(a.src);ne.clear();for(const[,a]of me)a.pause(),a.src&&URL.revokeObjectURL(a.src);me.clear(),S?.close()});function Re(a){const k=Math.floor(a/60),g=Math.floor(a%60);return`${k}:${g.toString().padStart(2,"0")}`}return(a,k)=>(E(),L("div",Pn,[t("div",{ref_key:"previewArea",ref:s,class:"flex-1 w-full flex items-center justify-center min-h-0"},[t("div",{ref:"canvasContainer",class:"relative ring-1 ring-zinc-500/60 rounded shadow-lg shadow-black/50",style:Oe(y.value)},[I.value?(E(),L("div",Ln,[t("button",{onClick:k[0]||(k[0]=g=>F(e).editMode="scale"),class:Me(["px-3 py-1 text-[11px] rounded font-semibold transition-colors whitespace-nowrap",F(e).editMode==="scale"?"bg-blue-600 text-white shadow-md shadow-blue-600/30":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600 hover:text-zinc-200"])},"Scale",2),t("button",{onClick:D,class:Me(["px-3 py-1 text-[11px] rounded font-semibold transition-colors whitespace-nowrap",F(e).editMode==="crop"?"bg-yellow-600 text-white shadow-md shadow-yellow-600/30":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600 hover:text-zinc-200"])},"Crop",2)])):de("",!0),t("canvas",{ref_key:"canvas",ref:i,class:"block w-full h-full bg-zinc-950 rounded",onClick:u},null,512),t("div",On,[I.value?(E(),L("div",{key:0,class:"absolute inset-0 pointer-events-auto z-0",onMousedown:k[1]||(k[1]=le(()=>{},["stop"])),onClick:k[2]||(k[2]=le(()=>{},["stop"]))},null,32)):de("",!0),(E(!0),L(Ce,null,Ee(r.value,g=>(E(),He(xn,{key:g.id,overlay:g,"container-width":v.value,"container-height":p.value,class:"pointer-events-auto"},null,8,["overlay","container-width","container-height"]))),128)),I.value&&F(e).editMode==="scale"?(E(),He(An,{key:1,clip:I.value,"bounds-x":R.value?.x??0,"bounds-y":R.value?.y??0,"bounds-w":R.value?.w??v.value,"bounds-h":R.value?.h??p.value,"container-width":v.value,"container-height":p.value},null,8,["clip","bounds-x","bounds-y","bounds-w","bounds-h","container-width","container-height"])):de("",!0),I.value&&F(e).editMode==="crop"?(E(),He(En,{key:2,clip:I.value,"video-x":Q.value.x,"video-y":Q.value.y,"video-w":Q.value.w,"video-h":Q.value.h,"container-width":v.value,"container-height":p.value},null,8,["clip","video-x","video-y","video-w","video-h","container-width","container-height"])):de("",!0)])],4)],512),t("div",jn,[t("button",{onClick:k[3]||(k[3]=g=>F(e).seek(0)),class:"w-8 h-8 rounded-lg bg-zinc-800 hover:bg-zinc-700 flex items-center justify-center",title:"Jump to start (Home)"},[...k[7]||(k[7]=[t("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},[t("path",{d:"M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"})],-1)])]),t("button",{onClick:k[4]||(k[4]=g=>F(e).seek(F(e).currentTime-1/30)),class:"w-8 h-8 rounded-lg bg-zinc-800 hover:bg-zinc-700 flex items-center justify-center",title:"Previous frame (â†)"},[...k[8]||(k[8]=[t("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},[t("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})],-1)])]),t("button",{onClick:W,class:"w-10 h-10 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center"},[F(e).isPlaying?(E(),L("svg",Rn,[...k[9]||(k[9]=[t("path",{d:"M6 4h4v16H6V4zm8 0h4v16h-4V4z"},null,-1)])])):(E(),L("svg",Wn,[...k[10]||(k[10]=[t("path",{d:"M8 5v14l11-7z"},null,-1)])]))]),t("button",{onClick:k[5]||(k[5]=g=>F(e).seek(F(e).currentTime+1/30)),class:"w-8 h-8 rounded-lg bg-zinc-800 hover:bg-zinc-700 flex items-center justify-center",title:"Next frame (â†’)"},[...k[11]||(k[11]=[t("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},[t("path",{d:"M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"})],-1)])]),t("button",{onClick:k[6]||(k[6]=g=>F(e).seek(F(e).projectDuration)),class:"w-8 h-8 rounded-lg bg-zinc-800 hover:bg-zinc-700 flex items-center justify-center",title:"Jump to end (End)"},[...k[12]||(k[12]=[t("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},[t("path",{d:"M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"})],-1)])]),t("span",Hn,ae(Re(F(e).currentTime))+" / "+ae(Re(F(e).projectDuration)),1)])]))}}),Fn={key:0,class:"text-[9px] text-zinc-500 mt-0.5 whitespace-nowrap"},Xn=Pe({__name:"TimelineRuler",setup(o){const e=Le(),n=K(()=>{const s=e.zoom,v=e.projectDuration+5,p=[];let l=1;s<15?l=10:s<30?l=5:s<80?l=2:l=1;for(let c=0;c<=v;c+=l){const y=Math.floor(c/60),r=c%60;p.push({time:c,x:c*s,label:`${y}:${r.toString().padStart(2,"0")}`,major:c%(l*5)===0||l>=5})}return p});function i(s){const v=s.currentTarget.getBoundingClientRect(),l=(s.clientX-v.left+e.scrollX)/e.zoom;e.seek(l)}return(s,v)=>(E(),L("div",{class:"relative h-6 bg-zinc-800 border-b border-zinc-700 cursor-pointer select-none overflow-hidden",onClick:i},[t("div",{class:"absolute top-0 left-0 h-full",style:Oe({transform:`translateX(-${F(e).scrollX}px)`})},[(E(!0),L(Ce,null,Ee(n.value,p=>(E(),L("div",{key:p.time,class:"absolute top-0 h-full flex flex-col items-center",style:Oe({left:p.x+"px"})},[t("div",{class:Me(["w-px",p.major?"h-3 bg-zinc-500":"h-2 bg-zinc-600"])},null,2),p.major?(E(),L("span",Fn,ae(p.label),1)):de("",!0)],4))),128))],4)]))}}),mt=160,yt=90,bt=2,it=new Map,at=new Set;function gt(o){return it.has(o)||it.set(o,rt([])),it.get(o)}function Nn(o){const e=Ue();function n(i){const s=gt(i);s.value.length>0||at.has(i)||e.items.find(v=>v.id===i)&&Bn(i,s)}return Fe(o,i=>{i&&n(i)},{immediate:!0}),Fe(()=>e.items.length,()=>{const i=o.value;i&&n(i)}),K(()=>{const i=o.value;return i?gt(i).value:[]})}function Bn(o,e){at.add(o),Yn(o,e).catch(()=>{}).finally(()=>at.delete(o))}async function Yn(o,e){const i=Ue().items.find(p=>p.id===o);if(!i||i.type!=="video")return;const s=URL.createObjectURL(i.blob),v=document.createElement("video");v.preload="auto",v.muted=!0,v.src=s;try{await Qe(v,"loadedmetadata");let p=v.duration;if((!isFinite(p)||p<=0)&&(v.currentTime=Number.MAX_SAFE_INTEGER,await Qe(v,"seeked"),p=v.duration,v.currentTime=0,await Qe(v,"seeked")),!isFinite(p)||p<=0)return;const l=document.createElement("canvas");l.width=mt,l.height=yt;const c=l.getContext("2d"),y=[],r=Math.max(1,Math.ceil(p/bt));for(let u=0;u<r;u++){const D=Math.min(u*bt,p-.1);v.currentTime=D,await Qe(v,"seeked"),c.drawImage(v,0,0,mt,yt);const I=l.toDataURL("image/jpeg",.6);y.push({time:D,dataUrl:I}),e.value=[...y]}}finally{v.pause(),v.removeAttribute("src"),v.load(),URL.revokeObjectURL(s)}}function Qe(o,e){return new Promise((n,i)=>{const s=()=>{p(),n()},v=()=>{p(),i(new Error(`${e} failed`))},p=()=>{o.removeEventListener(e,s),o.removeEventListener("error",v)};o.addEventListener(e,s,{once:!0}),o.addEventListener("error",v,{once:!0})})}const _n={key:0,class:"absolute inset-0 flex overflow-hidden opacity-60 pointer-events-none"},Kn=["src"],Vn={class:"relative px-2 py-0.5 text-[10px] text-white truncate pointer-events-none z-1 drop-shadow-[0_1px_1px_rgba(0,0,0,0.8)]"},xt=Pe({__name:"TimelineClip",props:{clip:{},overlayClip:{},trackId:{},trackType:{}},setup(o){const e=o,n=Le(),i=Ue(),s=K(()=>e.clip),v=K(()=>e.overlayClip),p=K(()=>v.value?v.value.type==="text"?v.value.text?.slice(0,20)||"Text":v.value.type==="image"?"Image":v.value.shape||"Shape":s.value?i.items.find(w=>w.id===s.value.mediaId)?.name||"Clip":""),l=K(()=>s.value||v.value),c=K(()=>s.value?n.selectedClipId===s.value.id:v.value?n.selectedOverlayId===v.value.id:!1),y=K(()=>l.value?{left:l.value.startTime*n.zoom+"px",width:Math.max(l.value.duration*n.zoom,4)+"px"}:{}),r=K(()=>v.value?v.value.type==="text"?"bg-amber-600/60 border-amber-500":v.value.type==="image"?"bg-pink-600/60 border-pink-500":"bg-sky-600/60 border-sky-500":e.trackType==="video"?"bg-emerald-600/60 border-emerald-500":"bg-violet-600/60 border-violet-500"),u=K(()=>s.value&&e.trackType==="video"?s.value.mediaId:null),D=Nn(u),I=K(()=>{const h=D.value;if(!h.length||!s.value)return[];const w=Math.max(s.value.duration*n.zoom,4),S=40,$=Math.ceil(w/S),d=[];for(let b=0;b<$;b++){const C=b/$*s.value.duration,j=s.value.trimStart+C;let X=h[0],be=Math.abs(X.time-j);for(const xe of h){const ye=Math.abs(xe.time-j);ye<be&&(X=xe,be=ye)}d.push({dataUrl:X.dataUrl,left:b*S})}return d}),J=Y(!1),Q=Y(!1);function R(h,w){const S=document.elementFromPoint(h,w);if(!S)return null;const $=S.closest("[data-track-id]");return!$?.dataset.trackId||!$.dataset.trackType?null:{id:$.dataset.trackId,type:$.dataset.trackType}}function ee(h){if(h.button!==0)return;h.stopPropagation();const w=s.value?.id||v.value?.id;if(!w)return;const S=w;n.pushSnapshot(),s.value?n.selectClip(S,e.trackId):v.value&&n.selectOverlay(S);const $=!!s.value,d=l.value.duration,b=h.clientX,C=l.value.startTime;let j=e.trackId;J.value=!0,Q.value=!1;function X(xe){const ye=xe.clientX-b,ve=Math.max(0,C+ye/n.zoom),{start:ge,snapped:P}=n.snapTime(ve,d,S);Q.value=P;const W=R(xe.clientX,xe.clientY);if($){const N=W&&(W.type==="video"||W.type==="audio")?W.id:j;n.moveClip(S,N,ge),j=N}else{const N=W&&W.type==="overlay"?W.id:j;n.moveOverlayClip(S,N,ge),j=N}}function be(){J.value=!1,Q.value=!1,document.removeEventListener("mousemove",X),document.removeEventListener("mouseup",be)}document.addEventListener("mousemove",X),document.addEventListener("mouseup",be)}const ue=Y(null),Z=Y(0),U=Y({startTime:0,duration:0,trimStart:0,trimEnd:0});function G(h,w){h.stopPropagation(),h.preventDefault(),l.value&&(n.pushSnapshot(),ue.value=w,Z.value=h.clientX,s.value?U.value={startTime:s.value.startTime,duration:s.value.duration,trimStart:s.value.trimStart,trimEnd:s.value.trimEnd}:v.value&&(U.value={startTime:v.value.startTime,duration:v.value.duration,trimStart:0,trimEnd:0}),document.addEventListener("mousemove",ne),document.addEventListener("mouseup",me))}function ne(h){if(!ue.value||!l.value)return;const S=(h.clientX-Z.value)/n.zoom,$=U.value;if(s.value)if(ue.value==="left"){const d=$.duration-.2,b=Math.max(-$.trimStart,Math.min(d,S));s.value.trimStart=$.trimStart+b,s.value.startTime=$.startTime+b,s.value.duration=$.duration-b}else{const d=$.duration-.2,b=Math.max(-$.trimEnd,Math.min(d,-S));s.value.trimEnd=$.trimEnd+b,s.value.duration=$.duration-b}else if(v.value)if(ue.value==="left"){const d=$.duration-.2,b=Math.max(-$.startTime,Math.min(d,S));n.updateOverlayClip(v.value.id,{startTime:$.startTime+b,duration:$.duration-b})}else{const d=Math.max(.2,$.duration+S);n.updateOverlayClip(v.value.id,{duration:d})}}function me(){ue.value=null,document.removeEventListener("mousemove",ne),document.removeEventListener("mouseup",me)}return(h,w)=>l.value?(E(),L("div",{key:0,class:Me(["absolute top-1 bottom-1 rounded border cursor-grab active:cursor-grabbing select-none overflow-hidden transition-shadow",[r.value,c.value?"ring-2 ring-white/90 shadow-[0_0_8px_rgba(255,255,255,0.4)] brightness-110":"",Q.value?"ring-2 ring-cyan-400":""]]),style:Oe(y.value),onMousedown:ee,onClick:w[2]||(w[2]=le(()=>{},["stop"]))},[I.value.length?(E(),L("div",_n,[(E(!0),L(Ce,null,Ee(I.value,(S,$)=>(E(),L("img",{key:$,src:S.dataUrl,class:"h-full w-10 object-cover shrink-0",draggable:"false"},null,8,Kn))),128))])):de("",!0),t("div",{class:"absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-white/20 z-10",onMousedown:w[0]||(w[0]=S=>G(S,"left"))},null,32),t("div",Vn,ae(p.value),1),t("div",{class:"absolute right-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-white/20 z-10",onMousedown:w[1]||(w[1]=S=>G(S,"right"))},null,32)],38)):de("",!0)}}),Jn={class:"w-36 shrink-0 flex items-center gap-1 px-1.5 bg-zinc-800 border-r border-zinc-700"},Zn={class:"text-[10px] font-mono text-zinc-400 truncate"},Gn={class:"ml-auto flex items-center gap-0.5"},qn={key:0,class:"flex items-center gap-px mr-1",title:"Layer order â€“ higher = on top"},Qn={class:"text-[10px] text-zinc-500 tabular-nums w-4 text-center select-none"},eo=["value","title"],to=["title"],no=["data-track-id","data-track-type"],oo=Pe({__name:"TimelineTrack",props:{track:{}},setup(o){const e=o,n=Le(),i=Ue();function s(y){const r=y.currentTarget.getBoundingClientRect(),u=y.clientX-r.left+n.scrollX;return Math.max(0,u/n.zoom)}function v(y,r){return{id:crypto.randomUUID(),mediaId:y.id,startTime:r,trimStart:0,trimEnd:0,duration:y.duration,blurAreas:[],crop:null}}async function p(y){if(y.preventDefault(),e.track.type==="overlay")return;const r=s(y),u=y.dataTransfer?.getData("application/x-media-id"),D=y.dataTransfer?.getData("application/x-media-type");if(u&&D){if(e.track.type==="video"&&D!=="video"||e.track.type==="audio"&&D!=="audio"&&D!=="video")return;const Q=i.items.find(R=>R.id===u);if(!Q)return;n.addClip(e.track.id,v(Q,r));return}const I=y.dataTransfer?.files;if(!I||I.length===0)return;let J=r;for(const Q of Array.from(I)){const R=await i.importFile(Q);R&&(e.track.type==="video"&&R.type!=="video"||e.track.type==="audio"&&R.type!=="audio"&&R.type!=="video"||(n.addClip(e.track.id,v(R,J)),J+=R.duration))}}function l(y){if(e.track.type==="overlay")return;const r=y.dataTransfer?.types??[],u=r.includes("application/x-media-id"),D=r.includes("Files");!u&&!D||(y.preventDefault(),y.dataTransfer&&(y.dataTransfer.dropEffect="copy"))}function c(y){const r=y.currentTarget.getBoundingClientRect(),D=(y.clientX-r.left+n.scrollX)/n.zoom;n.seek(D),n.clearSelection()}return(y,r)=>(E(),L("div",{class:Me(["flex border-b border-zinc-700/50",o.track.type==="video"?"h-14":"h-10"])},[t("div",Jn,[t("span",Zn,ae(o.track.label),1),t("div",Gn,[o.track.type!=="audio"?(E(),L("div",qn,[t("button",{onClick:r[0]||(r[0]=le(u=>F(n).moveTrackLayerDown(o.track.id),["stop"])),class:"w-4 h-4 flex items-center justify-center rounded hover:bg-zinc-600 text-zinc-500 hover:text-zinc-200 transition-colors",title:"Move layer down"},[...r[4]||(r[4]=[t("svg",{class:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)])]),t("span",Qn,ae(o.track.zIndex),1),t("button",{onClick:r[1]||(r[1]=le(u=>F(n).moveTrackLayerUp(o.track.id),["stop"])),class:"w-4 h-4 flex items-center justify-center rounded hover:bg-zinc-600 text-zinc-500 hover:text-zinc-200 transition-colors",title:"Move layer up"},[...r[5]||(r[5]=[t("svg",{class:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1)])])])):de("",!0),o.track.type!=="overlay"?(E(),L("input",{key:1,type:"range",min:"0",max:"1",step:"0.05",value:o.track.volume,onInput:r[2]||(r[2]=u=>F(n).setTrackVolume(o.track.id,Number(u.target.value))),class:"w-8 h-1 accent-zinc-400 cursor-pointer",title:`Volume: ${Math.round(o.track.volume*100)}%`},null,40,eo)):de("",!0),t("button",{onClick:r[3]||(r[3]=u=>F(n).toggleTrackMute(o.track.id)),class:Me(["text-[10px]",o.track.muted?"text-red-400":"text-zinc-500 hover:text-zinc-300"]),title:o.track.type==="overlay"?o.track.muted?"Show":"Hide":o.track.muted?"Unmute":"Mute"},[o.track.type==="overlay"?(E(),L(Ce,{key:0},[et(ae(o.track.muted?"ðŸ‘â€ðŸ—¨":"ðŸ‘"),1)],64)):(E(),L(Ce,{key:1},[et(ae(o.track.muted?"ðŸ”‡":"ðŸ”Š"),1)],64))],10,to)])]),t("div",{class:Me(["flex-1 relative overflow-hidden",o.track.type==="video"?"bg-zinc-800/30":o.track.type==="overlay"?"bg-zinc-800/20":"bg-zinc-800/40"]),"data-track-id":o.track.id,"data-track-type":o.track.type,onDrop:p,onDragover:l,onClick:c},[t("div",{class:"absolute top-0 left-0 h-full",style:Oe({transform:`translateX(-${F(n).scrollX}px)`})},[(E(!0),L(Ce,null,Ee(o.track.clips,u=>(E(),He(xt,{key:u.id,clip:u,"track-id":o.track.id,"track-type":o.track.type},null,8,["clip","track-id","track-type"]))),128)),(E(!0),L(Ce,null,Ee(o.track.overlayClips,u=>(E(),He(xt,{key:u.id,"overlay-clip":u,"track-id":o.track.id,"track-type":o.track.type},null,8,["overlay-clip","track-id","track-type"]))),128))],4)],42,no)],2))}}),io=Pe({__name:"TimelinePlayhead",setup(o){const e=Le(),n=K(()=>e.currentTime*e.zoom-e.scrollX),i=Y(!1);let s=null;function v(c){c.preventDefault(),c.stopPropagation(),i.value=!0,s=c.currentTarget.parentElement,document.addEventListener("mousemove",p),document.addEventListener("mouseup",l)}function p(c){if(!i.value||!s)return;const y=s.getBoundingClientRect(),r=c.clientX-y.left+e.scrollX;e.seek(r/e.zoom)}function l(){i.value=!1,s=null,document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",l)}return(c,y)=>(E(),L("div",{class:"absolute top-0 bottom-0 w-0.5 bg-red-500 z-20 pointer-events-auto cursor-col-resize",style:Oe({left:n.value+"px"}),onMousedown:v},[...y[0]||(y[0]=[t("div",{class:"absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-3 bg-red-500 rounded-full shadow"},null,-1)])],36))}}),ro={class:"flex items-center gap-2 px-2 py-1 border-b border-zinc-700 bg-zinc-800"},so=["disabled"],lo=["disabled"],ao=["title"],uo=["value"],co={class:"flex"},po={class:"flex-1 relative overflow-hidden"},vo={ref:"container",class:"flex-1 overflow-y-auto"},fo={class:"relative min-h-full"},mo={class:"absolute top-0 bottom-0 left-36 right-0 pointer-events-none"},yo=Pe({__name:"Timeline",setup(o){const e=Le(),n=K(()=>{if(e.selectedClipId){const l=e.selectedClip;if(!l)return!1;const c=e.currentTime-l.startTime;return c>.1&&c<l.duration-.1}if(e.selectedOverlayId){const l=e.selectedOverlay;if(!l)return!1;const c=e.currentTime-l.startTime;return c>.1&&c<l.duration-.1}return!1});function i(){e.selectedClipId?e.splitClipAtPlayhead(e.selectedClipId):e.selectedOverlayId&&e.splitOverlayAtPlayhead(e.selectedOverlayId)}function s(){e.selectedClipId?e.removeClip(e.selectedClipId):e.selectedOverlayId&&e.removeOverlayClip(e.selectedOverlayId)}function v(l){if(l.preventDefault(),l.ctrlKey||l.metaKey){const c=l.deltaY>0?-5:5;e.setZoom(e.zoom+c)}else e.scrollX=Math.max(0,e.scrollX+l.deltaX+l.deltaY)}function p(l){e.addTrack(l)}return(l,c)=>(E(),L("div",{class:"flex flex-col h-full bg-zinc-900 border-t border-zinc-700",onWheel:le(v,["prevent"])},[t("div",ro,[c[5]||(c[5]=t("span",{class:"text-[10px] text-zinc-500 uppercase tracking-wide"},"Timeline",-1)),c[6]||(c[6]=t("div",{class:"flex-1"},null,-1)),t("button",{onClick:c[0]||(c[0]=y=>p("video")),class:"px-1.5 py-0.5 text-[10px] bg-emerald-700 hover:bg-emerald-600 rounded",title:"Add video track"}," +V "),t("button",{onClick:c[1]||(c[1]=y=>p("overlay")),class:"px-1.5 py-0.5 text-[10px] bg-sky-700 hover:bg-sky-600 rounded",title:"Add overlay track"}," +OV "),t("button",{onClick:c[2]||(c[2]=y=>p("audio")),class:"px-1.5 py-0.5 text-[10px] bg-violet-700 hover:bg-violet-600 rounded",title:"Add audio track"}," +A "),c[7]||(c[7]=t("div",{class:"w-px h-4 bg-zinc-700"},null,-1)),t("button",{onClick:i,disabled:!n.value,class:"px-1.5 py-0.5 text-[10px] bg-orange-700 hover:bg-orange-600 disabled:opacity-30 disabled:cursor-not-allowed rounded",title:"Split at playhead (S)"}," Split ",8,so),t("button",{onClick:s,disabled:!F(e).selectedClipId&&!F(e).selectedOverlayId,class:"px-1.5 py-0.5 text-[10px] bg-red-700 hover:bg-red-600 disabled:opacity-30 disabled:cursor-not-allowed rounded",title:"Delete selected (Del)"}," Delete ",8,lo),c[8]||(c[8]=t("div",{class:"w-px h-4 bg-zinc-700"},null,-1)),t("button",{onClick:c[3]||(c[3]=y=>F(e).snapEnabled=!F(e).snapEnabled),class:Me(["px-1.5 py-0.5 text-[10px] rounded font-medium transition-colors",F(e).snapEnabled?"bg-cyan-600 text-white":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600"]),title:F(e).snapEnabled?"Snapping active â€“ click to disable":"Snapping disabled â€“ click to enable"}," Snap ",10,ao),c[9]||(c[9]=t("div",{class:"w-px h-4 bg-zinc-700"},null,-1)),c[10]||(c[10]=t("span",{class:"text-[10px] text-zinc-500"},"Zoom",-1)),t("input",{type:"range",min:"5",max:"200",value:F(e).zoom,onInput:c[4]||(c[4]=y=>F(e).setZoom(Number(y.target.value))),class:"w-20 h-1 accent-cyan-500"},null,40,uo)]),t("div",co,[c[11]||(c[11]=t("div",{class:"w-36 shrink-0 bg-zinc-800 border-r border-zinc-700"},null,-1)),t("div",po,[Ge(Xn)])]),t("div",vo,[t("div",fo,[(E(!0),L(Ce,null,Ee(F(e).project.tracks,y=>(E(),He(oo,{key:y.id,track:y},null,8,["track"]))),128)),t("div",mo,[Ge(io)])])],512)],32))}}),bo={key:0,class:"flex flex-col h-full bg-zinc-900 border-l border-zinc-700 overflow-y-auto"},go={class:"px-3 py-2 border-b border-zinc-700"},xo={class:"text-xs font-semibold text-zinc-400 uppercase tracking-wide"},ho={class:"p-3 space-y-3 text-xs"},wo={key:0},ko=["value"],zo={key:1,class:"grid grid-cols-2 gap-2"},Mo=["value"],To=["value"],Co=["value"],$o=["value"],So={key:2},Io={class:"grid grid-cols-2 gap-1 mt-1"},Eo=["onClick"],Do={key:3,class:"grid grid-cols-2 gap-2"},Ao=["value"],Po=["value"],Lo=["value"],Oo={key:0},jo=["value"],Ro={key:1},Wo=["value"],Ho={key:4,class:"border-t border-zinc-700 pt-3"},Uo={class:"grid grid-cols-2 gap-2 mt-1"},Fo=["value"],Xo=["value"],No=["value"],Bo=["value"],Yo={class:"mt-2"},_o=["value"],Ko={key:5,class:"border-t border-zinc-700 pt-3"},Vo={class:"grid grid-cols-2 gap-2 mt-1"},Jo=["value"],Zo=["value"],Go=["value"],qo=["value"],Qo={class:"grid grid-cols-2 gap-2 mt-2"},ei=["value"],ti=["value"],ni={class:"border-t border-zinc-700 pt-3"},oi={class:"grid grid-cols-2 gap-2 mt-1"},ii=["value"],ri=["value"],si={class:"border-t border-zinc-700 pt-3"},li={class:"grid grid-cols-2 gap-2 mt-1"},ai=["value"],ui=["value"],ci=["value"],di=["value"],pi=["value"],vi=["value"],fi={class:"border-t border-zinc-700 pt-3"},mi={class:"flex items-center justify-between mb-2"},yi={key:0,class:"text-zinc-600 text-[10px]"},bi={key:1,class:"space-y-1 max-h-32 overflow-y-auto"},gi={class:"flex-1 text-[10px] text-zinc-300 font-mono"},xi={class:"text-[9px] text-zinc-500 truncate max-w-16"},hi=["onClick"],wi={key:1,class:"flex flex-col items-center justify-center h-full bg-zinc-900 border-l border-zinc-700 text-zinc-600 text-xs p-4 text-center"},ki=Pe({__name:"OverlayEditor",setup(o){const e=Le(),n=K(()=>e.selectedOverlay);function i(y,r){n.value&&e.updateOverlayClip(n.value.id,{[y]:r})}const s=[{value:"none",label:"None"},{value:"fade",label:"Fade"},{value:"slide-left",label:"Slide Left"},{value:"slide-right",label:"Slide Right"},{value:"slide-up",label:"Slide Up"},{value:"slide-down",label:"Slide Down"},{value:"zoom-in",label:"Zoom In"},{value:"zoom-out",label:"Zoom Out"},{value:"typewriter",label:"Typewriter"},{value:"draw-in",label:"Draw In"}],v=[{value:"arrow",label:"âžœ Arrow"},{value:"rectangle",label:"â–­ Rect"},{value:"ellipse",label:"â¬­ Ellipse"},{value:"triangle",label:"â–³ Triangle"},{value:"line",label:"â€” Line"},{value:"star",label:"â˜… Star"},{value:"callout",label:"ðŸ’¬ Callout"}],p=K(()=>n.value?.shape==="arrow"&&n.value?.p1x!==void 0);function l(y){const r=[];return y.x!==void 0&&r.push("x"),y.y!==void 0&&r.push("y"),y.width!==void 0&&r.push("w"),y.height!==void 0&&r.push("h"),y.rotation!==void 0&&r.push("rot"),y.opacity!==void 0&&r.push("opa"),y.p1x!==void 0&&r.push("p1"),y.p2x!==void 0&&r.push("p2"),r.join(",")}function c(y){if(!n.value)return;const r={shape:y};y==="arrow"&&n.value.p1x===void 0&&(r.p1x=n.value.x,r.p1y=n.value.y+n.value.height/2,r.p2x=n.value.x+n.value.width,r.p2y=n.value.y+n.value.height/2),e.updateOverlayClip(n.value.id,r)}return(y,r)=>n.value?(E(),L("div",bo,[t("div",go,[t("span",xo,ae(n.value.type==="text"?"Text":n.value.type==="image"?"Image":"Shape")+" Properties ",1)]),t("div",ho,[n.value.type==="text"?(E(),L("div",wo,[r[29]||(r[29]=t("label",{class:"text-zinc-500"},"Text",-1)),t("textarea",{value:n.value.text,onInput:r[0]||(r[0]=u=>i("text",u.target.value)),class:"w-full mt-1 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200 text-xs resize-none",rows:"2"},null,40,ko)])):de("",!0),n.value.type==="text"?(E(),L("div",zo,[t("div",null,[r[31]||(r[31]=t("label",{class:"text-zinc-500"},"Font",-1)),t("select",{value:n.value.fontFamily||"sans-serif",onChange:r[1]||(r[1]=u=>i("fontFamily",u.target.value)),class:"w-full mt-1 px-1 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200"},[...r[30]||(r[30]=[t("option",{value:"sans-serif"},"Sans-serif",-1),t("option",{value:"serif"},"Serif",-1),t("option",{value:"monospace"},"Monospace",-1),t("option",{value:"cursive"},"Cursive",-1)])],40,Mo)]),t("div",null,[r[32]||(r[32]=t("label",{class:"text-zinc-500"},"Size",-1)),t("input",{type:"number",value:n.value.fontSize||32,onInput:r[2]||(r[2]=u=>i("fontSize",Number(u.target.value))),class:"w-full mt-1 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"8",max:"200"},null,40,To)]),t("div",null,[r[33]||(r[33]=t("label",{class:"text-zinc-500"},"Color",-1)),t("input",{type:"color",value:n.value.fontColor||"#ffffff",onInput:r[3]||(r[3]=u=>i("fontColor",u.target.value)),class:"w-full mt-1 h-7 bg-zinc-800 border border-zinc-700 rounded cursor-pointer"},null,40,Co)]),t("div",null,[r[35]||(r[35]=t("label",{class:"text-zinc-500"},"Weight",-1)),t("select",{value:n.value.fontWeight||"normal",onChange:r[4]||(r[4]=u=>i("fontWeight",u.target.value)),class:"w-full mt-1 px-1 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200"},[...r[34]||(r[34]=[t("option",{value:"normal"},"Normal",-1),t("option",{value:"bold"},"Bold",-1)])],40,$o)])])):de("",!0),n.value.type==="shape"?(E(),L("div",So,[r[36]||(r[36]=t("label",{class:"text-zinc-500"},"Shape",-1)),t("div",Io,[(E(),L(Ce,null,Ee(v,u=>t("button",{key:u.value,onClick:D=>c(u.value),class:Me(["px-1 py-1 rounded text-[10px]",n.value.shape===u.value?"bg-cyan-600 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"])},ae(u.label),11,Eo)),64))])])):de("",!0),n.value.type==="shape"?(E(),L("div",Do,[t("div",null,[r[37]||(r[37]=t("label",{class:"text-zinc-500"},"Fill",-1)),t("input",{type:"color",value:n.value.fillColor||"#3b82f6",onInput:r[5]||(r[5]=u=>i("fillColor",u.target.value)),class:"w-full mt-1 h-7 bg-zinc-800 border border-zinc-700 rounded cursor-pointer"},null,40,Ao)]),t("div",null,[r[38]||(r[38]=t("label",{class:"text-zinc-500"},"Stroke",-1)),t("input",{type:"color",value:n.value.strokeColor||"#ffffff",onInput:r[6]||(r[6]=u=>i("strokeColor",u.target.value)),class:"w-full mt-1 h-7 bg-zinc-800 border border-zinc-700 rounded cursor-pointer"},null,40,Po)]),t("div",null,[r[39]||(r[39]=t("label",{class:"text-zinc-500"},"Stroke W.",-1)),t("input",{type:"number",value:n.value.strokeWidth||2,onInput:r[7]||(r[7]=u=>i("strokeWidth",Number(u.target.value))),class:"w-full mt-1 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"1",max:"20"},null,40,Lo)]),p.value?(E(),L("div",Oo,[r[40]||(r[40]=t("label",{class:"text-zinc-500"},"Head Size",-1)),t("input",{type:"number",value:n.value.arrowHeadSize||18,onInput:r[8]||(r[8]=u=>i("arrowHeadSize",Number(u.target.value))),class:"w-full mt-1 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"5",max:"60"},null,40,jo)])):de("",!0),p.value?de("",!0):(E(),L("div",Ro,[r[41]||(r[41]=t("label",{class:"text-zinc-500"},"Radius",-1)),t("input",{type:"number",value:n.value.borderRadius||0,onInput:r[9]||(r[9]=u=>i("borderRadius",Number(u.target.value))),class:"w-full mt-1 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,Wo)]))])):de("",!0),p.value?(E(),L("div",Ho,[r[47]||(r[47]=t("label",{class:"text-zinc-500 font-semibold"},"Endpoints",-1)),t("div",Uo,[t("div",null,[r[42]||(r[42]=t("label",{class:"text-zinc-600"},"Start X %",-1)),t("input",{type:"number",value:Math.round(n.value.p1x??0),onInput:r[10]||(r[10]=u=>i("p1x",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,Fo)]),t("div",null,[r[43]||(r[43]=t("label",{class:"text-zinc-600"},"Start Y %",-1)),t("input",{type:"number",value:Math.round(n.value.p1y??0),onInput:r[11]||(r[11]=u=>i("p1y",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,Xo)]),t("div",null,[r[44]||(r[44]=t("label",{class:"text-zinc-600"},"End X %",-1)),t("input",{type:"number",value:Math.round(n.value.p2x??0),onInput:r[12]||(r[12]=u=>i("p2x",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,No)]),t("div",null,[r[45]||(r[45]=t("label",{class:"text-zinc-600"},"End Y %",-1)),t("input",{type:"number",value:Math.round(n.value.p2y??0),onInput:r[13]||(r[13]=u=>i("p2y",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,Bo)])]),t("div",Yo,[r[46]||(r[46]=t("label",{class:"text-zinc-600"},"Opacity",-1)),t("input",{type:"range",value:n.value.opacity,onInput:r[14]||(r[14]=u=>i("opacity",Number(u.target.value))),min:"0",max:"1",step:"0.05",class:"w-full accent-cyan-500"},null,40,_o)])])):(E(),L("div",Ko,[r[54]||(r[54]=t("label",{class:"text-zinc-500 font-semibold"},"Position & Size",-1)),t("div",Vo,[t("div",null,[r[48]||(r[48]=t("label",{class:"text-zinc-600"},"X %",-1)),t("input",{type:"number",value:Math.round(n.value.x),onInput:r[15]||(r[15]=u=>i("x",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,Jo)]),t("div",null,[r[49]||(r[49]=t("label",{class:"text-zinc-600"},"Y %",-1)),t("input",{type:"number",value:Math.round(n.value.y),onInput:r[16]||(r[16]=u=>i("y",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,Zo)]),t("div",null,[r[50]||(r[50]=t("label",{class:"text-zinc-600"},"W %",-1)),t("input",{type:"number",value:Math.round(n.value.width),onInput:r[17]||(r[17]=u=>i("width",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"1",max:"100"},null,40,Go)]),t("div",null,[r[51]||(r[51]=t("label",{class:"text-zinc-600"},"H %",-1)),t("input",{type:"number",value:Math.round(n.value.height),onInput:r[18]||(r[18]=u=>i("height",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"1",max:"100"},null,40,qo)])]),t("div",Qo,[t("div",null,[r[52]||(r[52]=t("label",{class:"text-zinc-600"},"Opacity",-1)),t("input",{type:"range",value:n.value.opacity,onInput:r[19]||(r[19]=u=>i("opacity",Number(u.target.value))),min:"0",max:"1",step:"0.05",class:"w-full accent-cyan-500"},null,40,ei)]),t("div",null,[r[53]||(r[53]=t("label",{class:"text-zinc-600"},"Rotation",-1)),t("input",{type:"number",value:n.value.rotation,onInput:r[20]||(r[20]=u=>i("rotation",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"-360",max:"360"},null,40,ti)])])])),t("div",ni,[r[57]||(r[57]=t("label",{class:"text-zinc-500 font-semibold"},"Timing",-1)),t("div",oi,[t("div",null,[r[55]||(r[55]=t("label",{class:"text-zinc-600"},"Start (s)",-1)),t("input",{type:"number",value:n.value.startTime.toFixed(1),onInput:r[21]||(r[21]=u=>i("startTime",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",step:"0.1"},null,40,ii)]),t("div",null,[r[56]||(r[56]=t("label",{class:"text-zinc-600"},"Duration (s)",-1)),t("input",{type:"number",value:n.value.duration.toFixed(1),onInput:r[22]||(r[22]=u=>i("duration",Number(u.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0.1",step:"0.1"},null,40,ri)])])]),t("div",si,[r[62]||(r[62]=t("label",{class:"text-zinc-500 font-semibold"},"Animation",-1)),t("div",li,[t("div",null,[r[58]||(r[58]=t("label",{class:"text-zinc-600"},"Enter",-1)),t("select",{value:n.value.enterAnimation,onChange:r[23]||(r[23]=u=>i("enterAnimation",u.target.value)),class:"w-full mt-0.5 px-1 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200"},[(E(),L(Ce,null,Ee(s,u=>t("option",{key:u.value,value:u.value},ae(u.label),9,ui)),64))],40,ai)]),t("div",null,[r[59]||(r[59]=t("label",{class:"text-zinc-600"},"Enter dur. (s)",-1)),t("input",{type:"number",value:n.value.enterDuration,onInput:r[24]||(r[24]=u=>i("enterDuration",Number(u.target.value))),class:"w-full mt-0.5 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"10",step:"0.1"},null,40,ci)]),t("div",null,[r[60]||(r[60]=t("label",{class:"text-zinc-600"},"Exit",-1)),t("select",{value:n.value.exitAnimation,onChange:r[25]||(r[25]=u=>i("exitAnimation",u.target.value)),class:"w-full mt-0.5 px-1 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200"},[(E(),L(Ce,null,Ee(s,u=>t("option",{key:u.value,value:u.value},ae(u.label),9,pi)),64))],40,di)]),t("div",null,[r[61]||(r[61]=t("label",{class:"text-zinc-600"},"Exit dur. (s)",-1)),t("input",{type:"number",value:n.value.exitDuration,onInput:r[26]||(r[26]=u=>i("exitDuration",Number(u.target.value))),class:"w-full mt-0.5 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"10",step:"0.1"},null,40,vi)])])]),t("div",fi,[t("div",mi,[r[63]||(r[63]=t("label",{class:"text-zinc-500 font-semibold"},"Keyframes",-1)),n.value.keyframes&&n.value.keyframes.length?(E(),L("button",{key:0,onClick:r[27]||(r[27]=u=>F(e).clearKeyframes(n.value.id)),class:"px-1.5 py-0.5 text-[10px] bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded"},"Clear All")):de("",!0)]),!n.value.keyframes||n.value.keyframes.length===0?(E(),L("div",yi," No keyframes. Drag overlays on the preview to create keyframes at the current playhead. ")):(E(),L("div",bi,[(E(!0),L(Ce,null,Ee(n.value.keyframes,(u,D)=>(E(),L("div",{key:D,class:"flex items-center gap-1 px-1.5 py-1 bg-zinc-800 rounded group"},[r[64]||(r[64]=t("span",{class:"text-amber-400 text-[10px]"},"â—†",-1)),t("span",gi,ae(u.time.toFixed(2))+"s",1),t("span",xi,ae(l(u)),1),t("button",{onClick:I=>F(e).removeKeyframe(n.value.id,D),class:"hidden group-hover:block text-[10px] text-red-400 hover:text-red-300 ml-1"},"âœ•",8,hi)]))),128))]))]),t("button",{onClick:r[28]||(r[28]=u=>F(e).removeOverlayClip(n.value.id)),class:"w-full py-1.5 bg-red-600/20 hover:bg-red-600/30 border border-red-600/30 text-red-400 rounded text-xs"}," Delete Overlay ")])])):(E(),L("div",wi,[...r[65]||(r[65]=[t("p",null,"Select an overlay clip to edit its properties.",-1)])]))}}),zi={key:0,class:"flex flex-col h-full bg-zinc-900 border-l border-zinc-700 overflow-y-auto"},Mi={class:"px-3 py-2 border-b border-zinc-700"},Ti={class:"text-xs font-semibold text-zinc-400 uppercase tracking-wide"},Ci={class:"p-3 space-y-3 text-xs"},$i={class:"text-zinc-500"},Si={key:0},Ii={key:0,class:"border-t border-zinc-700 pt-3"},Ei={class:"flex items-center gap-2 mt-1.5"},Di=["title"],Ai={key:1,class:"border-t border-zinc-700 pt-3 space-y-3"},Pi={class:"flex items-center justify-between mb-1"},Li={class:"text-zinc-500 tabular-nums"},Oi=["value","max"],ji={class:"flex items-center justify-between mb-1"},Ri={class:"text-zinc-500 tabular-nums"},Wi=["value","max"],Hi={key:2,class:"border-t border-zinc-700 pt-3"},Ui={key:0,class:"text-zinc-500 mt-1"},Fi={class:"grid grid-cols-2 gap-2 mt-2"},Xi=["value"],Ni=["value"],Bi=["value"],Yi=["value"],_i={key:3,class:"border-t border-zinc-700 pt-3"},Ki={class:"flex items-center justify-between"},Vi=["title"],Ji={key:0,class:"grid grid-cols-2 gap-2 mt-2"},Zi=["value"],Gi=["value"],qi=["value"],Qi=["value"],er={key:4,class:"border-t border-zinc-700 pt-3"},tr={class:"flex items-center justify-between"},nr={class:"flex gap-1"},or={key:0,class:"text-zinc-600 text-[10px] mt-2"},ir={class:"flex items-center justify-between"},rr={class:"text-zinc-400 text-[10px] uppercase font-semibold"},sr=["onClick"],lr={class:"grid grid-cols-2 gap-1.5"},ar=["value","onInput"],ur=["value","onInput"],cr=["value","onInput"],dr=["value","onInput"],pr=["value","onChange"],vr=Pe({__name:"ClipEditor",setup(o){const e=Le(),n=Ue(),i=K(()=>e.selectedClip),s=K(()=>e.selectedTrackId?e.project.tracks.find($=>$.id===e.selectedTrackId)??null:null),v=K(()=>s.value?.type??null),p=K(()=>v.value==="audio"),l=K(()=>{const $=e.selectedClipId;if(!$)return null;for(const d of e.project.tracks){const b=d.clips.find(C=>C.id===$);if(b)return b.crop??null}return null}),c=K(()=>{if(!i.value||p.value)return null;const $=n.items.find(j=>j.id===i.value.mediaId);if(!$?.width||!$?.height)return null;let d=$.width,b=$.height;const C=l.value;return C&&(d=Math.round(d*C.width/100),b=Math.round(b*C.height/100)),{w:d,h:b}}),y=K(()=>{if(!i.value||p.value)return null;const $=e.project.stageWidth||1920,d=e.project.stageHeight||1080;return{w:Math.round((i.value.stageW??100)/100*$),h:Math.round((i.value.stageH??100)/100*d)}});function r(){if(!i.value)return;const $=e.project.stageWidth||1920,d=e.project.stageHeight||1080,b=Math.round((i.value.stageW??100)/100*$),C=Math.round((i.value.stageH??100)/100*d);e.setStageSize(b,C);for(const j of e.project.tracks){const X=j.clips.find(be=>be.id===i.value.id);if(X){X.stageX=0,X.stageY=0,X.stageW=100,X.stageH=100;break}}}function u(){if(i.value)for(const $ of e.project.tracks){const d=$.clips.find(b=>b.id===i.value.id);if(d){d.stageX=0,d.stageY=0,d.stageW=100,d.stageH=100;break}}}const D=K(()=>i.value?.fadeIn??0),I=K(()=>i.value?.fadeOut??0),J=K(()=>i.value?i.value.duration/2:5);function Q($){i.value&&e.updateClip(i.value.id,{fadeIn:Math.max(0,Math.min($,J.value))})}function R($){i.value&&e.updateClip(i.value.id,{fadeOut:Math.max(0,Math.min($,J.value))})}function ee($){if(!i.value)return;const d={id:crypto.randomUUID(),x:30,y:30,width:20,height:20,type:$};e.addBlurArea(i.value.id,d)}function ue($){i.value&&e.removeBlurArea(i.value.id,$)}function Z($,d,b){i.value&&e.updateBlurArea(i.value.id,$,{[d]:b})}function U(){i.value&&(e.pushSnapshot(),i.value.crop?e.setCrop(i.value.id,null):e.setCrop(i.value.id,{x:10,y:10,width:80,height:80}))}function G($,d){!i.value||!i.value.crop||(e.pushSnapshot(),e.setCrop(i.value.id,{...i.value.crop,[$]:d}))}const ne=K(()=>e.selectedTrackId?e.project.tracks.find(d=>d.id===e.selectedTrackId)?.clips.length??0:0);function me(){i.value&&e.applyCropToTrack(i.value.id)}function h(){e.editMode="crop",i.value&&!i.value.crop&&(e.pushSnapshot(),e.setCrop(i.value.id,{x:0,y:0,width:100,height:100}))}function w($,d){i.value&&e.updateClip(i.value.id,{[$]:d})}function S(){i.value&&e.applyScaleToTrack(i.value.id)}return($,d)=>i.value?(E(),L("div",zi,[t("div",Mi,[t("span",Ti,ae(p.value?"Audio":"Clip")+" Properties ",1)]),t("div",Ci,[t("div",$i,[t("div",null,"Start: "+ae(i.value.startTime.toFixed(1))+"s",1),t("div",null,"Duration: "+ae(i.value.duration.toFixed(1))+"s",1),t("div",null,"Trim: "+ae(i.value.trimStart.toFixed(1))+"s â€“ "+ae(i.value.trimEnd.toFixed(1))+"s",1),c.value?(E(),L("div",Si,"Resolution: "+ae(c.value.w)+" Ã— "+ae(c.value.h),1)):de("",!0)]),!p.value&&s.value?(E(),L("div",Ii,[d[18]||(d[18]=t("label",{class:"text-zinc-500 font-semibold"},"Layer Order",-1)),t("div",Ei,[t("button",{onClick:d[0]||(d[0]=b=>F(e).moveTrackLayerDown(s.value.id)),class:"px-2 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-zinc-300 text-[11px] font-medium transition-colors",title:"Move layer down (behind)"},[...d[16]||(d[16]=[t("svg",{class:"w-3.5 h-3.5 inline -mt-px mr-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1),et(" Back ",-1)])]),t("span",{class:"text-zinc-400 text-xs tabular-nums flex-1 text-center",title:`z-index: ${s.value.zIndex}`},ae(s.value.label)+" â€“ Layer "+ae(s.value.zIndex),9,Di),t("button",{onClick:d[1]||(d[1]=b=>F(e).moveTrackLayerUp(s.value.id)),class:"px-2 py-1 bg-zinc-700 hover:bg-zinc-600 rounded text-zinc-300 text-[11px] font-medium transition-colors",title:"Move layer up (in front)"},[...d[17]||(d[17]=[et(" Front ",-1),t("svg",{class:"w-3.5 h-3.5 inline -mt-px ml-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1)])])])])):de("",!0),p.value?(E(),L("div",Ai,[d[21]||(d[21]=t("label",{class:"text-zinc-500 font-semibold"},"Audio Fade",-1)),t("div",null,[t("div",Pi,[d[19]||(d[19]=t("label",{class:"text-zinc-400"},"Fade In",-1)),t("span",Li,ae(D.value.toFixed(1))+"s",1)]),t("input",{type:"range",value:D.value,onInput:d[2]||(d[2]=b=>Q(Number(b.target.value))),min:"0",max:J.value,step:"0.1",class:"w-full accent-violet-500"},null,40,Oi)]),t("div",null,[t("div",ji,[d[20]||(d[20]=t("label",{class:"text-zinc-400"},"Fade Out",-1)),t("span",Ri,ae(I.value.toFixed(1))+"s",1)]),t("input",{type:"range",value:I.value,onInput:d[3]||(d[3]=b=>R(Number(b.target.value))),min:"0",max:J.value,step:"0.1",class:"w-full accent-violet-500"},null,40,Wi)])])):de("",!0),p.value?de("",!0):(E(),L("div",Hi,[t("button",{onClick:d[4]||(d[4]=b=>F(e).editMode="scale"),class:Me(["text-xs font-semibold px-2 py-0.5 rounded transition-colors",F(e).editMode==="scale"?"bg-blue-600/20 text-blue-400 ring-1 ring-blue-500/40":"text-zinc-500 hover:text-zinc-300"])},"Scale / Position",2),y.value?(E(),L("div",Ui," Size on stage: "+ae(y.value.w)+" Ã— "+ae(y.value.h)+" px ",1)):de("",!0),t("div",Fi,[t("div",null,[d[22]||(d[22]=t("label",{class:"text-zinc-600"},"X %",-1)),t("input",{type:"number",value:Math.round(i.value.stageX??0),onInput:d[5]||(d[5]=b=>w("stageX",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"-50",max:"100"},null,40,Xi)]),t("div",null,[d[23]||(d[23]=t("label",{class:"text-zinc-600"},"Y %",-1)),t("input",{type:"number",value:Math.round(i.value.stageY??0),onInput:d[6]||(d[6]=b=>w("stageY",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"-50",max:"100"},null,40,Ni)]),t("div",null,[d[24]||(d[24]=t("label",{class:"text-zinc-600"},"W %",-1)),t("input",{type:"number",value:Math.round(i.value.stageW??100),onInput:d[7]||(d[7]=b=>w("stageW",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"5",max:"200"},null,40,Bi)]),t("div",null,[d[25]||(d[25]=t("label",{class:"text-zinc-600"},"H %",-1)),t("input",{type:"number",value:Math.round(i.value.stageH??100),onInput:d[8]||(d[8]=b=>w("stageH",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"5",max:"200"},null,40,Yi)])]),t("div",{class:"flex gap-2 mt-2"},[t("button",{onClick:r,class:"flex-1 py-1.5 bg-cyan-600/20 hover:bg-cyan-600/30 border border-cyan-600/30 text-cyan-400 rounded text-xs",title:"Resize stage to match video resolution"}," Fit stage to video "),t("button",{onClick:u,class:"flex-1 py-1.5 bg-violet-600/20 hover:bg-violet-600/30 border border-violet-600/30 text-violet-400 rounded text-xs",title:"Reset clip bounds to fill the entire stage"}," Fit video to stage ")]),ne.value>1?(E(),L("button",{key:1,onClick:S,class:"w-full mt-2 py-1.5 bg-amber-600/20 hover:bg-amber-600/30 border border-amber-600/30 text-amber-400 rounded text-xs",title:"Apply this scale/position to all clips in the same track"}," Apply scale to track ")):de("",!0)])),p.value?de("",!0):(E(),L("div",_i,[t("div",Ki,[t("button",{onClick:h,class:Me(["text-xs font-semibold px-2 py-0.5 rounded transition-colors",F(e).editMode==="crop"?"bg-yellow-600/20 text-yellow-400 ring-1 ring-yellow-500/40":"text-zinc-500 hover:text-zinc-300"])},"Crop",2),t("button",{onClick:U,class:Me(["px-2 py-0.5 rounded text-[10px] font-medium",i.value.crop?"bg-red-600 text-white hover:bg-red-500":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600"]),title:i.value.crop?"Disable crop":"Enable crop"},ae(i.value.crop?"Reset":"Off"),11,Vi)]),i.value.crop?(E(),L("div",Ji,[t("div",null,[d[26]||(d[26]=t("label",{class:"text-zinc-600"},"X %",-1)),t("input",{type:"number",value:Math.round(i.value.crop.x),onInput:d[9]||(d[9]=b=>G("x",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"90"},null,40,Zi)]),t("div",null,[d[27]||(d[27]=t("label",{class:"text-zinc-600"},"Y %",-1)),t("input",{type:"number",value:Math.round(i.value.crop.y),onInput:d[10]||(d[10]=b=>G("y",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"0",max:"90"},null,40,Gi)]),t("div",null,[d[28]||(d[28]=t("label",{class:"text-zinc-600"},"W %",-1)),t("input",{type:"number",value:Math.round(i.value.crop.width),onInput:d[11]||(d[11]=b=>G("width",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"5",max:"100"},null,40,qi)]),t("div",null,[d[29]||(d[29]=t("label",{class:"text-zinc-600"},"H %",-1)),t("input",{type:"number",value:Math.round(i.value.crop.height),onInput:d[12]||(d[12]=b=>G("height",Number(b.target.value))),class:"w-full px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-zinc-200",min:"5",max:"100"},null,40,Qi)]),ne.value>1?(E(),L("button",{key:0,onClick:me,class:"col-span-2 mt-1 py-1.5 bg-amber-600/20 hover:bg-amber-600/30 border border-amber-600/30 text-amber-400 rounded text-xs",title:"Apply this crop to all clips in the same track"}," Apply crop to track ")):de("",!0)])):de("",!0)])),p.value?de("",!0):(E(),L("div",er,[t("div",tr,[d[30]||(d[30]=t("label",{class:"text-zinc-500 font-semibold"},"Blur / Pixelate",-1)),t("div",nr,[t("button",{onClick:d[13]||(d[13]=b=>ee("blur")),class:"px-2 py-0.5 rounded text-[10px] bg-zinc-700 text-zinc-300 hover:bg-zinc-600 font-medium"},"+ Blur"),t("button",{onClick:d[14]||(d[14]=b=>ee("pixelate")),class:"px-2 py-0.5 rounded text-[10px] bg-zinc-700 text-zinc-300 hover:bg-zinc-600 font-medium"},"+ Pixel")])]),i.value.blurAreas.length===0?(E(),L("div",or," No blur areas. Click + to add one. ")):de("",!0),(E(!0),L(Ce,null,Ee(i.value.blurAreas,b=>(E(),L("div",{key:b.id,class:"mt-2 p-2 bg-zinc-800 rounded border border-zinc-700 space-y-1.5"},[t("div",ir,[t("span",rr,ae(b.type),1),t("button",{onClick:C=>ue(b.id),class:"text-red-400 hover:text-red-300 text-[10px]"},"Remove",8,sr)]),t("div",lr,[t("div",null,[d[31]||(d[31]=t("label",{class:"text-zinc-600"},"X %",-1)),t("input",{type:"number",value:Math.round(b.x),onInput:C=>Z(b.id,"x",Number(C.target.value)),class:"w-full px-1.5 py-0.5 bg-zinc-900 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,ar)]),t("div",null,[d[32]||(d[32]=t("label",{class:"text-zinc-600"},"Y %",-1)),t("input",{type:"number",value:Math.round(b.y),onInput:C=>Z(b.id,"y",Number(C.target.value)),class:"w-full px-1.5 py-0.5 bg-zinc-900 border border-zinc-700 rounded text-zinc-200",min:"0",max:"100"},null,40,ur)]),t("div",null,[d[33]||(d[33]=t("label",{class:"text-zinc-600"},"W %",-1)),t("input",{type:"number",value:Math.round(b.width),onInput:C=>Z(b.id,"width",Number(C.target.value)),class:"w-full px-1.5 py-0.5 bg-zinc-900 border border-zinc-700 rounded text-zinc-200",min:"1",max:"100"},null,40,cr)]),t("div",null,[d[34]||(d[34]=t("label",{class:"text-zinc-600"},"H %",-1)),t("input",{type:"number",value:Math.round(b.height),onInput:C=>Z(b.id,"height",Number(C.target.value)),class:"w-full px-1.5 py-0.5 bg-zinc-900 border border-zinc-700 rounded text-zinc-200",min:"1",max:"100"},null,40,dr)])]),t("div",null,[d[36]||(d[36]=t("label",{class:"text-zinc-600"},"Type",-1)),t("select",{value:b.type,onChange:C=>Z(b.id,"type",C.target.value),class:"w-full px-1 py-0.5 bg-zinc-900 border border-zinc-700 rounded text-zinc-200 mt-0.5"},[...d[35]||(d[35]=[t("option",{value:"blur"},"Blur",-1),t("option",{value:"pixelate"},"Pixelate",-1)])],40,pr)])]))),128))])),t("button",{onClick:d[15]||(d[15]=b=>F(e).removeClip(i.value.id)),class:"w-full py-1.5 bg-red-600/20 hover:bg-red-600/30 border border-red-600/30 text-red-400 rounded text-xs"}," Delete Clip ")])])):de("",!0)}}),fr={class:"flex flex-col h-screen bg-zinc-950 text-white select-none overflow-hidden"},mr={class:"flex items-center gap-3 px-4 py-2 bg-zinc-800 border-b border-zinc-700"},yr={class:"text-xs text-zinc-500"},br=["disabled"],gr=["disabled"],xr=["disabled"],hr=["disabled"],wr={class:"flex flex-1 min-h-0"},kr={class:"w-52 shrink-0"},zr={class:"flex-1 min-w-0"},Mr={class:"w-56 shrink-0 bg-zinc-900 border-l border-zinc-700"},Tr={key:2,class:"flex flex-col gap-4 p-3"},Cr={class:"flex flex-wrap gap-1 mb-2"},$r=["onClick"],Sr={class:"flex gap-2 items-center"},Ir=["value"],Er=["value"],Dr={class:"h-56 shrink-0"},Ar={class:"w-96 max-h-[70vh] bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl flex flex-col"},Pr={class:"flex items-center justify-between px-4 py-3 border-b border-zinc-700"},Lr={class:"flex-1 overflow-y-auto p-2 space-y-1"},Or={key:0,class:"text-xs text-zinc-500 text-center py-6"},jr=["onClick"],Rr={class:"flex-1 text-xs text-zinc-300 truncate"},Wr={class:"text-[10px] text-zinc-600"},Hr=["onClick"],Ur=Pe({__name:"App",setup(o){const e=Le();Ue();const{exportProject:n,progress:i,isExporting:s,format:v}=nn(),p=K(()=>!!e.selectedOverlay),l=K(()=>{if(!e.selectedClip||!e.selectedTrackId)return!1;const h=e.project.tracks.find(w=>w.id===e.selectedTrackId);return h?.type==="video"||h?.type==="audio"}),c=Y(!1),y=Y([]);async function r(){y.value=await kt(),c.value=!0}async function u(h){e.loadProject(h);for(const w of h.tracks)for(const S of w.overlayClips??[])S.type==="image"&&S.imageData&&st(S.imageData);c.value=!1}async function D(h){await Ut(h),y.value=y.value.filter(w=>w.id!==h)}function I(){const h=prompt("Project name:","Untitled Project");h!==null&&(e.newProject(h||"Untitled Project"),c.value=!1)}function J(){if(e.project.name==="Untitled Project"){const h=prompt("Project name:","");if(h===null)return;e.renameProject(h||"Untitled Project")}e.saveNow()}async function Q(){const h=prompt("Save as:",e.project.name);h!==null&&await e.saveAsNewProject(h||"Untitled Project")}function R(h){(h.key==="Delete"||h.key==="Backspace")&&(e.selectedClipId?e.removeClip(e.selectedClipId):e.selectedOverlayId&&e.removeOverlayClip(e.selectedOverlayId));const w=h.target?.tagName,S=w==="INPUT"||w==="TEXTAREA"||w==="SELECT";if(h.key===" "&&!S&&(h.preventDefault(),e.setPlaying(!e.isPlaying)),h.key==="Home"&&(h.preventDefault(),e.seek(0)),h.key==="End"&&(h.preventDefault(),e.seek(e.projectDuration)),h.key==="ArrowLeft"&&!S&&(h.preventDefault(),e.seek(e.currentTime-1/30)),h.key==="ArrowRight"&&!S&&(h.preventDefault(),e.seek(e.currentTime+1/30)),h.key==="z"&&(h.ctrlKey||h.metaKey)&&!h.shiftKey){h.preventDefault(),e.undo();return}if(h.key==="z"&&(h.ctrlKey||h.metaKey)&&h.shiftKey||h.key==="y"&&(h.ctrlKey||h.metaKey)){h.preventDefault(),e.redo();return}if(h.key==="s"&&(h.ctrlKey||h.metaKey)&&!h.shiftKey){h.preventDefault(),J();return}if(h.key==="s"&&(h.ctrlKey||h.metaKey)&&h.shiftKey){h.preventDefault(),Q();return}h.key==="s"&&!S&&(e.selectedClipId?e.splitClipAtPlayhead(e.selectedClipId):e.selectedOverlayId&&e.splitOverlayAtPlayhead(e.selectedOverlayId))}ut(async()=>{document.addEventListener("keydown",R),await e.loadRecentProject()}),wt(()=>{document.removeEventListener("keydown",R)});function ee(){return e.project.tracks.find(w=>w.type==="overlay")?.id||null}function ue(){const h=ee();if(!h)return;const w={id:crypto.randomUUID(),type:"text",startTime:e.currentTime,duration:5,x:30,y:40,width:40,height:10,rotation:0,opacity:1,text:"Hello World",fontFamily:"sans-serif",fontSize:48,fontColor:"#ffffff",fontWeight:"bold",textAlign:"center",enterAnimation:"fade",exitAnimation:"fade",enterDuration:.5,exitDuration:.5,keyframes:[]};e.addOverlayClip(h,w),e.selectOverlay(w.id)}function Z(){const h=ee();if(!h)return;const w={id:crypto.randomUUID(),type:"shape",startTime:e.currentTime,duration:5,x:30,y:30,width:20,height:20,rotation:0,opacity:1,shape:"arrow",fillColor:"#ef4444",strokeColor:"#ef4444",strokeWidth:3,arrowHeadSize:18,p1x:25,p1y:50,p2x:75,p2y:50,enterAnimation:"none",exitAnimation:"none",enterDuration:0,exitDuration:.5,keyframes:[]};e.addOverlayClip(h,w),e.selectOverlay(w.id)}function U(){const h=document.createElement("input");h.type="file",h.accept="image/*",h.onchange=async()=>{const w=h.files?.[0];if(!w)return;const S=new FileReader;S.onload=async()=>{const $=ee();if(!$)return;const d={id:crypto.randomUUID(),type:"image",startTime:e.currentTime,duration:5,x:30,y:30,width:20,height:20,rotation:0,opacity:1,imageData:S.result,enterAnimation:"fade",exitAnimation:"fade",enterDuration:.5,exitDuration:.5,keyframes:[]};await st(d.imageData),e.addOverlayClip($,d),e.selectOverlay(d.id)},S.readAsDataURL(w)},h.click()}const G=[{label:"1920Ã—1080",w:1920,h:1080},{label:"1280Ã—720",w:1280,h:720},{label:"3840Ã—2160",w:3840,h:2160},{label:"1080Ã—1920",w:1080,h:1920},{label:"1080Ã—1080",w:1080,h:1080}];function ne(h){const w=parseInt(h.target.value);w>0&&e.setStageSize(w,e.project.stageHeight)}function me(h){const w=parseInt(h.target.value);w>0&&e.setStageSize(e.project.stageWidth,w)}return(h,w)=>(E(),L("div",fr,[t("header",mr,[w[7]||(w[7]=t("h1",{class:"text-sm font-bold text-cyan-400"},"CaptureKit Editor",-1)),t("span",yr,ae(F(e).project.name),1),t("button",{onClick:I,class:"px-2 py-1 text-[11px] bg-zinc-700 hover:bg-zinc-600 rounded",title:"New Project"},"New"),t("button",{onClick:r,class:"px-2 py-1 text-[11px] bg-zinc-700 hover:bg-zinc-600 rounded",title:"Load Project"},"Open"),t("button",{onClick:J,class:"px-2 py-1 text-[11px] bg-zinc-700 hover:bg-zinc-600 rounded",title:"Save now (Ctrl+S)"},"Save"),t("button",{onClick:Q,class:"px-2 py-1 text-[11px] bg-zinc-700 hover:bg-zinc-600 rounded",title:"Save as new project"},"Save As"),w[8]||(w[8]=t("div",{class:"w-px h-5 bg-zinc-700"},null,-1)),t("button",{onClick:w[0]||(w[0]=S=>F(e).undo()),disabled:!F(e).canUndo,class:"px-2 py-1 text-[11px] bg-zinc-700 rounded disabled:opacity-30 disabled:cursor-not-allowed hover:enabled:bg-zinc-600",title:"Undo (Ctrl+Z)"},"Undo",8,br),t("button",{onClick:w[1]||(w[1]=S=>F(e).redo()),disabled:!F(e).canRedo,class:"px-2 py-1 text-[11px] bg-zinc-700 rounded disabled:opacity-30 disabled:cursor-not-allowed hover:enabled:bg-zinc-600",title:"Redo (Ctrl+Shift+Z)"},"Redo",8,gr),w[9]||(w[9]=t("div",{class:"flex-1"},null,-1)),t("button",{onClick:ue,class:"px-2 py-1 text-[11px] bg-amber-700 hover:bg-amber-600 rounded font-medium"},"+ Text"),t("button",{onClick:U,class:"px-2 py-1 text-[11px] bg-pink-700 hover:bg-pink-600 rounded font-medium"},"+ Image"),t("button",{onClick:Z,class:"px-2 py-1 text-[11px] bg-sky-700 hover:bg-sky-600 rounded font-medium"},"+ Shape"),w[10]||(w[10]=t("div",{class:"w-px h-5 bg-zinc-700"},null,-1)),Dt(t("select",{"onUpdate:modelValue":w[2]||(w[2]=S=>Pt(v)?v.value=S:null),disabled:F(s),class:"px-1 py-1 text-[11px] bg-zinc-700 border border-zinc-600 rounded text-zinc-200 disabled:opacity-50"},[...w[6]||(w[6]=[t("option",{value:"mp4"},"MP4",-1),t("option",{value:"webm"},"WebM",-1)])],8,xr),[[At,F(v)]]),t("button",{onClick:w[3]||(w[3]=(...S)=>F(n)&&F(n)(...S)),disabled:F(s),class:"px-3 py-1 text-xs bg-red-600 hover:bg-red-500 disabled:opacity-50 rounded font-medium"},ae(F(s)?`Exporting ${Math.round(F(i))}%`:"Export"),9,hr)]),t("div",wr,[t("div",kr,[Ge(fn)]),t("div",zr,[Ge(Un)]),t("div",Mr,[p.value?(E(),He(ki,{key:0})):l.value?(E(),He(vr,{key:1})):(E(),L("div",Tr,[t("div",null,[w[13]||(w[13]=t("h3",{class:"text-xs font-bold text-zinc-300 mb-2"},"Stage Size",-1)),t("div",Cr,[(E(),L(Ce,null,Ee(G,S=>t("button",{key:S.label,onClick:$=>F(e).setStageSize(S.w,S.h),class:Me(["px-2 py-1 text-[10px] rounded font-medium",F(e).project.stageWidth===S.w&&F(e).project.stageHeight===S.h?"bg-cyan-600 text-white":"bg-zinc-700 hover:bg-zinc-600 text-zinc-300"])},ae(S.label),11,$r)),64))]),t("div",Sr,[w[11]||(w[11]=t("label",{class:"text-[10px] text-zinc-500"},"W",-1)),t("input",{type:"number",value:F(e).project.stageWidth,onChange:ne,class:"w-16 px-1 py-0.5 text-[11px] bg-zinc-800 border border-zinc-600 rounded text-zinc-200"},null,40,Ir),w[12]||(w[12]=t("label",{class:"text-[10px] text-zinc-500"},"H",-1)),t("input",{type:"number",value:F(e).project.stageHeight,onChange:me,class:"w-16 px-1 py-0.5 text-[11px] bg-zinc-800 border border-zinc-600 rounded text-zinc-200"},null,40,Er)])]),w[14]||(w[14]=t("span",{class:"text-zinc-600 text-xs leading-relaxed text-center"}," Select a clip in the timeline to edit crop, blur & other properties. ",-1))]))])]),t("div",Dr,[Ge(yo)]),c.value?(E(),L("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",onClick:w[5]||(w[5]=le(S=>c.value=!1,["self"]))},[t("div",Ar,[t("div",Pr,[w[15]||(w[15]=t("h2",{class:"text-sm font-bold text-zinc-200"},"Projects",-1)),t("button",{onClick:w[4]||(w[4]=S=>c.value=!1),class:"text-zinc-500 hover:text-white text-lg leading-none"},"Ã—")]),t("div",Lr,[y.value.length===0?(E(),L("div",Or,"No saved projects.")):de("",!0),(E(!0),L(Ce,null,Ee(y.value,S=>(E(),L("div",{key:S.id,class:Me(["flex items-center gap-2 px-3 py-2 rounded hover:bg-zinc-800 cursor-pointer group",S.id===F(e).project.id?"bg-zinc-800 ring-1 ring-cyan-500/40":""]),onClick:$=>u(S)},[t("span",Rr,ae(S.name),1),t("span",Wr,ae(S.tracks.reduce(($,d)=>$+d.clips.length+d.overlayClips.length,0))+" clips",1),t("button",{onClick:le($=>D(S.id),["stop"]),class:"hidden group-hover:block text-[10px] text-red-400 hover:text-red-300"},"Delete",8,Hr)],10,jr))),128))]),t("div",{class:"px-4 py-3 border-t border-zinc-700"},[t("button",{onClick:I,class:"w-full py-1.5 text-xs bg-cyan-600 hover:bg-cyan-500 rounded font-medium"},"+ New Project")])])])):de("",!0)]))}}),Fr=Lt(),It=Ot(Ur);It.use(Fr);It.mount("#app");
